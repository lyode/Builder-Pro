<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro AI">
    <meta name="apple-mobile-web-app-title" content="Builder Pro AI">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#d2bcbf">
    <meta name="msapplication-navbutton-color" content="#d2bcbf">
    <meta name="msapplication-starturl" content="/">
    <meta name="format-detection" content="telephone=no">
    
    <title>Builder Pro AI - Intelligent Project Manager</title>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            
            /* Default Theme - Pink/Rose */
            --bg-color: #F4EDEB;
            --accent-color: #d2bcbf;
            --highlight-color: #a67980;
            --text-color: #1C1C1C;
            
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
            
            /* Gantt Chart Colors */
            --gantt-project1: #99b3ec;
            --gantt-project2: #90b2b8;
            --gantt-project3: #c0ccb8;
            --gantt-project4: #e0b558;
            --gantt-project5: #d2bcbf;
            --gantt-project6: #8386a4;
            --gantt-critical: #ef4444;
            --gantt-milestone: #6366f1;
        }

        /* Theme Color Schemes */
        .theme-rose {
            --accent-color: #d2bcbf;
            --highlight-color: #a67980;
        }

        .theme-sage {
            --accent-color: #c0ccb8;
            --highlight-color: #60665c;
        }

        .theme-gold {
            --accent-color: #e0b558;
            --highlight-color: #ecd299;
        }

        .theme-ocean {
            --accent-color: #99b3ec;
            --highlight-color: #151b73;
        }

        .theme-lavender {
            --accent-color: #8386a4;
            --highlight-color: #191a22;
        }

        .theme-teal {
            --accent-color: #90b2b8;
            --highlight-color: #2c4144;
        }

        .theme-seafoam {
            --accent-color: #9cbbbf;
            --highlight-color: #436266;
        }
        
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body { filter: contrast(var(--contrast)) brightness(var(--brightness)); }
        
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }

        body.sat-low { filter: saturate(0.7) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-normal { filter: saturate(1) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-high { filter: saturate(1.3) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-vibrant { filter: saturate(1.6) contrast(var(--contrast)) brightness(var(--brightness)); }

        .night-mode { 
            --bg-color: #1a1618 !important; 
            --card-bg: #2d2729 !important; 
            --text-color: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border-color: #4a4246 !important; 
            --shadow-color: rgba(0,0,0,0.3) !important;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: all 0.3s; 
            font-size: calc(14px * var(--font-scale));
        }
        
        .app-container { 
            max-width: 100vw; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        @media (display-mode: standalone) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .main-content-wrapper {
                margin-top: calc(260px + max(20px, env(safe-area-inset-top)));
            }
        }
        
        @supports (padding-top: max(0px)) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .header {
                padding-top: 12px;
            }
        }
        
        .fixed-header-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg-color);
            padding-top: var(--safe-area-inset-top);
        }
        
        .header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 10px 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .header h1 { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .header-subtitle { 
            font-size: calc(11px * var(--font-scale)); 
            opacity: 0.9; 
            margin-top: 2px; 
        }
        
        .header-controls { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: calc(14px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: background 0.2s;
        }
        
        .header-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .ai-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .sync-indicator { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 8px; 
            height: 8px; 
            background: #10b981; 
            border-radius: 50%; 
            animation: pulse 2s infinite; 
            display: none; 
        }
        
        .sync-indicator.syncing { 
            display: block; 
            background: #f39c12; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        .stats-bar { 
            background: white; 
            padding: 10px 12px; 
            display: flex; 
            justify-content: space-around; 
            box-shadow: 0 1px 3px var(--shadow-color); 
        }
        
        .stat-item { 
            text-align: center; 
            flex: 1; 
            padding: 2px;
        }
        
        .stat-value { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: bold; 
            color: var(--text-color); 
        }
        
        .stat-label { 
            font-size: calc(10px * var(--font-scale)); 
            color: var(--text-secondary); 
            margin-top: 2px; 
        }
        
        .nav-tabs { 
            background: var(--card-bg); 
            display: flex; 
            border-bottom: 1px solid var(--border-color); 
            padding: 0 12px; 
            gap: 20px; 
            overflow-x: auto; 
            scrollbar-width: none;
        }
        
        .nav-tabs::-webkit-scrollbar { display: none; }
        
        .nav-tab { 
            padding: 12px 4px; 
            cursor: pointer; 
            white-space: nowrap; 
            border-bottom: 2px solid transparent; 
            color: var(--text-secondary); 
            transition: all 0.2s; 
            font-size: calc(13px * var(--font-scale)); 
        }
        
        .nav-tab.active { 
            color: var(--highlight-color); 
            border-bottom-color: var(--highlight-color); 
            font-weight: 500; 
        }
        
        .main-content-wrapper {
            margin-top: 260px;
        }
        
        .main-content { 
            flex: 1; 
            padding: 12px; 
            max-width: 100%; 
            overflow-x: hidden; 
            min-height: calc(100vh - 260px);
        }
        
        .section { 
            display: none; 
            animation: fadeIn 0.3s; 
        }
        
        .section.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        .add-btn { 
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            right: calc(20px + env(safe-area-inset-right)); 
            background: linear-gradient(135deg, var(--accent-color), var(--highlight-color)); 
            color: white; 
            width: 56px; 
            height: 56px; 
            border-radius: 50%; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px var(--shadow-color); 
            z-index: 50; 
            transition: transform 0.2s; 
        }
        
        .add-btn:active { 
            transform: scale(0.95); 
        }
        
        .card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 14px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 8px var(--shadow-color); 
            position: relative; 
            overflow: hidden; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:active {
            transform: scale(0.99);
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 8px; 
            gap: 10px;
        }
        
        .card-title { 
            font-weight: 600; 
            font-size: calc(14px * var(--font-scale)); 
            color: var(--text-color); 
            word-break: break-word;
            flex: 1; 
        }
        
        .card-meta { 
            font-size: calc(11px * var(--font-scale)); 
            color: var(--text-secondary); 
            margin-top: 4px; 
        }
        
        .card-actions { 
            display: flex; 
            gap: 6px;
            flex-shrink: 0;
        }
        
        .card-btn { 
            background: transparent; 
            border: none; 
            color: var(--text-secondary); 
            cursor: pointer; 
            padding: 6px; 
            border-radius: 50%; 
            font-size: calc(16px * var(--font-scale)); 
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .card-btn:active { 
            background: var(--border-color); 
        }
        
        .progress-bar { 
            height: 6px; 
            background: var(--border-color); 
            border-radius: 3px; 
            overflow: hidden; 
            margin-top: 10px; 
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--accent-color), var(--highlight-color)); 
            border-radius: 3px; 
            transition: width 0.3s; 
        }

        /* Gantt Chart Styles */
        .gantt-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .gantt-title {
            font-weight: 600;
            font-size: calc(16px * var(--font-scale));
            color: var(--text-color);
        }

        .gantt-controls {
            display: flex;
            gap: 8px;
        }

        .gantt-btn {
            padding: 6px 12px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: calc(12px * var(--font-scale));
            cursor: pointer;
            transition: all 0.2s;
        }

        .gantt-btn.active {
            background: var(--highlight-color);
            color: white;
            border-color: var(--highlight-color);
        }

        .gantt-chart {
            position: relative;
            min-height: 200px;
            background: var(--bg-color);
            border-radius: 8px;
            padding: 10px;
            overflow-x: auto;
        }

        .gantt-timeline {
            display: flex;
            position: relative;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 10px;
            font-size: calc(11px * var(--font-scale));
            color: var(--text-secondary);
        }

        .gantt-month {
            flex: 1;
            text-align: center;
            padding: 4px;
            border-right: 1px solid var(--border-color);
        }

        .gantt-rows {
            position: relative;
        }

        .gantt-row {
            display: flex;
            align-items: center;
            min-height: 40px;
            margin-bottom: 8px;
            position: relative;
        }

        .gantt-label {
            width: 120px;
            padding-right: 10px;
            font-size: calc(12px * var(--font-scale));
            color: var(--text-color);
            font-weight: 500;
        }

        .gantt-bars {
            flex: 1;
            position: relative;
            height: 30px;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 10%,
                var(--border-color) 10%,
                var(--border-color) 10.1%
            );
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            top: 3px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: calc(11px * var(--font-scale));
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gantt-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .gantt-bar.critical {
            background: var(--gantt-critical);
        }

        .gantt-bar.milestone {
            background: var(--gantt-milestone);
            width: 20px !important;
            height: 20px;
            transform: rotate(45deg);
            padding: 0;
        }

        .mini-gantt {
            height: 60px;
            background: var(--bg-color);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            position: relative;
            overflow: hidden;
        }

        .mini-gantt-bar {
            position: absolute;
            height: 8px;
            background: var(--accent-color);
            border-radius: 4px;
            opacity: 0.7;
        }

        /* AI Assistant Styles */
        .ai-assistant {
            position: fixed;
            bottom: calc(90px + env(safe-area-inset-bottom));
            right: calc(20px + env(safe-area-inset-right));
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            z-index: 49;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-assistant:active {
            transform: scale(0.95);
        }

        .ai-panel {
            position: fixed;
            bottom: calc(150px + env(safe-area-inset-bottom));
            right: calc(20px + env(safe-area-inset-right));
            width: 320px;
            max-height: 400px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 16px;
            display: none;
            z-index: 100;
            animation: slideUp 0.3s;
        }

        .ai-panel.active {
            display: block;
        }

        .ai-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .ai-panel-title {
            font-weight: 600;
            font-size: calc(14px * var(--font-scale));
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-close {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .ai-suggestions {
            max-height: 300px;
            overflow-y: auto;
        }

        .ai-suggestion {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .ai-suggestion:hover {
            transform: translateX(4px);
            background: linear-gradient(90deg, var(--bg-color), var(--accent-color) 200%);
        }

        .ai-suggestion-title {
            font-weight: 500;
            font-size: calc(12px * var(--font-scale));
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .ai-suggestion-desc {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .ai-priority {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: calc(10px * var(--font-scale));
            font-weight: 600;
            margin-left: 8px;
        }

        .ai-priority.high {
            background: #fef2f2;
            color: #dc2626;
        }

        .ai-priority.medium {
            background: #fffbeb;
            color: #d97706;
        }

        .ai-priority.low {
            background: #f0fdf4;
            color: #16a34a;
        }
        
        .task-item { 
            display: flex; 
            align-items: center; 
            padding: 8px; 
            background: var(--bg-color); 
            border-radius: 8px; 
            margin-bottom: 6px; 
            gap: 10px;
        }
        
        .task-checkbox { 
            width: 20px; 
            height: 20px; 
            accent-color: var(--highlight-color); 
            flex-shrink: 0; 
        }
        
        .task-text { 
            flex: 1; 
            font-size: calc(13px * var(--font-scale)); 
            word-break: break-word; 
        }
        
        .task-text.completed { 
            text-decoration: line-through; 
            opacity: 0.6; 
        }
        
        .delete-task-btn {
            background: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 4px;
            font-size: calc(14px * var(--font-scale));
            opacity: 0.7;
        }
        
        .delete-task-btn:active {
            opacity: 1;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-color);
            border-radius: 8px;
            margin-bottom: 6px;
        }
        
        .transaction-amount {
            font-weight: bold;
            font-size: calc(14px * var(--font-scale));
        }
        
        .income { color: var(--income-color); }
        .expense { color: var(--expense-color); }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 200; 
            animation: fadeIn 0.2s; 
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .modal.active { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        .modal-content { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 20px; 
            width: 90%; 
            max-width: 400px; 
            max-height: 80vh; 
            overflow-y: auto; 
            animation: slideUp 0.3s; 
        }
        
        @keyframes slideUp { 
            from { transform: translateY(50px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        .modal-header { 
            font-size: calc(18px * var(--font-scale)); 
            font-weight: bold; 
            margin-bottom: 16px; 
            color: var(--text-color);
        }
        
        .form-group { 
            margin-bottom: 16px; 
        }
        
        .form-label { 
            display: block; 
            font-size: calc(12px * var(--font-scale)); 
            color: var(--text-secondary); 
            margin-bottom: 6px; 
        }
        
        .form-input, .form-select, .form-textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: calc(14px * var(--font-scale)); 
            background: var(--card-bg); 
            color: var(--text-color); 
            transition: border-color 0.2s;
        }
        
        .form-textarea { 
            resize: vertical; 
            min-height: 80px; 
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus { 
            outline: none; 
            border-color: var(--highlight-color); 
        }
        
        .form-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
        }
        
        .btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            font-size: calc(14px * var(--font-scale)); 
            font-weight: 500; 
            cursor: pointer; 
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--accent-color), var(--highlight-color)); 
            color: white; 
        }
        
        .btn-secondary { 
            background: var(--border-color); 
            color: var(--text-color); 
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--text-secondary); 
        }
        
        .empty-icon { 
            font-size: 48px; 
            margin-bottom: 16px; 
            opacity: 0.3; 
        }
        
        .empty-text { 
            font-size: calc(14px * var(--font-scale)); 
            line-height: 1.5; 
        }
        
        .toast { 
            position: fixed; 
            bottom: calc(100px + env(safe-area-inset-bottom)); 
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--button-primary); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 20px; 
            font-size: calc(13px * var(--font-scale)); 
            z-index: 300; 
            opacity: 0; 
            transition: opacity 0.3s; 
            pointer-events: none; 
            max-width: 80%; 
            text-align: center; 
        }
        
        .toast.show { 
            opacity: 0.95; 
        }
        
        .settings-group {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-row:last-child {
            border-bottom: none;
        }
        
        .settings-label {
            font-size: calc(14px * var(--font-scale));
            color: var(--text-color);
            flex: 1;
        }
        
        .settings-value {
            font-size: calc(13px * var(--font-scale));
            color: var(--text-secondary);
        }
        
        .switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--border-color);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .switch.active {
            background: var(--highlight-color);
        }
        
        .switch-handle {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .switch.active .switch-handle {
            transform: translateX(22px);
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-option {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: calc(12px * var(--font-scale));
            transition: all 0.2s;
        }
        
        .btn-option.active {
            background: var(--highlight-color);
            color: white;
            border-color: var(--highlight-color);
        }
        
        #syncStatus {
            padding: 8px 12px;
            background: var(--bg-color);
            border-radius: 8px;
            font-size: calc(11px * var(--font-scale));
            margin-top: 8px;
        }
        
        .currency-note {
            font-size: calc(11px * var(--font-scale));
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 4px;
        }

        /* Sticky Note Styles */
        .sticky-note {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-2deg);
            background: linear-gradient(135deg, #fff9c4 0%, #ffeb3b 100%);
            width: 280px;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 
                0 10px 40px rgba(0,0,0,0.3),
                inset 0 -40px 40px rgba(0,0,0,0.05);
            z-index: 1000;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            animation: popIn 0.4s ease-out, wobble 0.5s ease-in-out 0.4s;
            display: none;
        }

        .sticky-note::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 30px;
            background: rgba(255,255,255,0.6);
            border: 1px solid #ddd;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sticky-note.show {
            display: block;
        }

        .sticky-note-header {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            text-decoration: underline;
            text-decoration-style: wavy;
            text-decoration-color: #ff9800;
        }

        .sticky-note-content {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        .sticky-note-content .check-item {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }

        .sticky-note-content .check-item::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        .sticky-note-footer {
            margin-top: 15px;
            font-size: 11px;
            color: #666;
            text-align: center;
            font-style: italic;
        }

        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-2deg);
                opacity: 0;
            }
            70% {
                transform: translate(-50%, -50%) scale(1.1) rotate(-2deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(-2deg);
                opacity: 1;
            }
        }

        @keyframes wobble {
            0%, 100% { transform: translate(-50%, -50%) rotate(-2deg); }
            25% { transform: translate(-50%, -50%) rotate(2deg); }
            75% { transform: translate(-50%, -50%) rotate(-1deg); }
        }

        /* Theme Color Picker */
        .theme-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            overflow: hidden;
        }

        .theme-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            transition: all 0.3s;
        }

        .theme-option::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            transition: all 0.3s;
        }

        .theme-option.active {
            border-color: var(--text-color);
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .theme-option.active::before {
            content: '‚úì';
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            height: 100%;
            background: rgba(0,0,0,0.3) !important;
        }

        .theme-option.active::after {
            display: none;
        }

        /* Individual theme colors for picker */
        .theme-option[data-theme="rose"]::before { background: #d2bcbf; }
        .theme-option[data-theme="rose"]::after { background: #a67980; }

        .theme-option[data-theme="sage"]::before { background: #c0ccb8; }
        .theme-option[data-theme="sage"]::after { background: #60665c; }

        .theme-option[data-theme="gold"]::before { background: #e0b558; }
        .theme-option[data-theme="gold"]::after { background: #ecd299; }

        .theme-option[data-theme="ocean"]::before { background: #99b3ec; }
        .theme-option[data-theme="ocean"]::after { background: #151b73; }

        .theme-option[data-theme="lavender"]::before { background: #8386a4; }
        .theme-option[data-theme="lavender"]::after { background: #191a22; }

        .theme-option[data-theme="teal"]::before { background: #90b2b8; }
        .theme-option[data-theme="teal"]::after { background: #2c4144; }

        .theme-option[data-theme="seafoam"]::before { background: #9cbbbf; }
        .theme-option[data-theme="seafoam"]::after { background: #436266; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="fixed-header-section">
            <header class="header">
                <div class="header-content">
                    <div class="header-left" onclick="goHome()">
                        <div>
                            <h1>üèóÔ∏è Builder Pro AI</h1>
                            <div class="header-subtitle">Intelligent Project Manager</div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="showAIAssistant()" title="AI Assistant">
                            ü§ñ
                            <span class="ai-badge">AI</span>
                        </button>
                        <button class="header-btn" onclick="performSync()" title="Sync">
                            ‚òÅÔ∏è
                            <span class="sync-indicator" id="syncIndicator"></span>
                        </button>
                        <button class="header-btn" onclick="showTrash()" title="Trash">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </header>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="projectCount">0</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="taskCount">0</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completionRate">0%</div>
                    <div class="stat-label">Complete</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalBalance">$0</div>
                    <div class="stat-label">Balance</div>
                </div>
            </div>
            
            <nav class="nav-tabs">
                <div class="nav-tab active" onclick="switchView('projects')">Projects</div>
                <div class="nav-tab" onclick="switchView('schedule')">Schedule</div>
                <div class="nav-tab" onclick="switchView('tasks')">Tasks</div>
                <div class="nav-tab" onclick="switchView('financial')">Financial</div>
                <div class="nav-tab" onclick="switchView('settings')">Settings</div>
            </nav>
        </div>
        
        <div class="main-content-wrapper">
            <main class="main-content">
                <div id="projectsSection" class="section active"></div>
                <div id="scheduleSection" class="section"></div>
                <div id="tasksSection" class="section"></div>
                <div id="financialSection" class="section"></div>
                <div id="settingsSection" class="section"></div>
            </main>
        </div>
        
        <button class="add-btn" id="addBtn" onclick="openAddModal()">+</button>
        <button class="ai-assistant" onclick="toggleAIPanel()">ü§ñ</button>
        
        <!-- AI Panel -->
        <div id="aiPanel" class="ai-panel">
            <div class="ai-panel-header">
                <div class="ai-panel-title">
                    <span>ü§ñ</span>
                    <span>AI Assistant</span>
                </div>
                <button class="ai-close" onclick="toggleAIPanel()">√ó</button>
            </div>
            <div class="ai-suggestions" id="aiSuggestions">
                <!-- AI suggestions will be dynamically generated -->
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">New Project</div>
            <div class="form-group">
                <label class="form-label">Project Name</label>
                <input type="text" class="form-input" id="projectName" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="projectDescription" placeholder="Project description (optional)"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-input" id="projectStartDate">
            </div>
            <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="date" class="form-input" id="projectEndDate">
            </div>
            <div class="form-group">
                <label class="form-label">Budget (optional)</label>
                <input type="number" class="form-input" id="projectBudget" placeholder="0.00">
                <div class="currency-note">Currency: <span id="currencyDisplay">USD</span></div>
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select class="form-select" id="projectPriority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal('addProjectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Create</button>
            </div>
        </div>
    </div>
    
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">New Task</div>
            <div class="form-group">
                <label class="form-label">Task Description</label>
                <input type="text" class="form-input" id="taskDescription" placeholder="What needs to be done?">
            </div>
            <div class="form-group">
                <label class="form-label">Project</label>
                <select class="form-select" id="taskProject"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" class="form-input" id="taskDueDate">
            </div>
            <div class="form-group">
                <label class="form-label">Estimated Hours</label>
                <input type="number" class="form-input" id="taskEstimatedHours" placeholder="0" min="0" step="0.5">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal('addTaskModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Add Task</button>
            </div>
        </div>
    </div>
    
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">New Transaction</div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-select" id="transactionType">
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" class="form-input" id="transactionAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="transactionDescription" placeholder="What is this for?">
            </div>
            <div class="form-group">
                <label class="form-label">Project</label>
                <select class="form-select" id="transactionProject">
                    <option value="">No Project</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal('addTransactionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTransaction()">Add</button>
            </div>
        </div>
    </div>
    
    <div id="trashModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üóëÔ∏è Trash</div>
            <div id="trashContent"></div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal('trashModal')">Close</button>
                <button class="btn btn-primary" onclick="emptyTrash()">Empty Trash</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <!-- Sticky Note Reminder -->
    <div id="stickyNote" class="sticky-note">
        <div class="sticky-note-header">üìå Quick Check!</div>
        <div class="sticky-note-content" id="stickyNoteContent">
            <!-- Content will be dynamically generated -->
        </div>
        <div class="sticky-note-footer">Auto-closing in 5 seconds...</div>
    </div>
    
    <script>
        // Data structure
        let data = {
            projects: [],
            tasks: [],
            transactions: [],
            trash: [],
            permanentlyDeleted: [],
            settings: {
                nightMode: false,
                currency: 'USD',
                contrast: 'normal',
                fontSize: 'm',
                saturation: 'normal',
                theme: 'rose',
                aiEnabled: true
            }
        };
        
        // App state
        let currentView = 'projects';
        let syncApiKey = '';
        let reminderInterval = null;
        let apiTempDisabled = false;
        let ganttView = 'month'; // month, week, day
        
        // App configuration
        const APP_CONFIG = {
            baseUrl: 'https://api.jsonbin.io/v3',
            binId: '678e017dacd3cb34a8c57f18'
        };
        
        // Initialize app
        function init() {
            loadData();
            applySettings();
            
            // Check if this is first run or user wants to clear
            if (localStorage.getItem('clearDataFlag') === 'true' || !localStorage.getItem('builderProData')) {
                clearAllData();
                localStorage.removeItem('clearDataFlag');
            }
            
            renderView();
            updateStats();
            checkSyncStatus();
            setupReminderSystem();
            initializeAI();
            
            // Load API key from localStorage
            const savedApiKey = localStorage.getItem('builderProSyncApiKey');
            if (savedApiKey) {
                syncApiKey = savedApiKey;
                document.getElementById('syncMode').textContent = 'Ready';
            }
            
            // Check if launched as PWA
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('Running as PWA');
            }
            
            // Set today's date as default for new projects/tasks
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectStartDate').value = today;
            document.getElementById('taskDueDate').value = today;
        }
        
        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('builderProData');
            if (saved) {
                try {
                    data = JSON.parse(saved);
                    // Ensure all properties exist
                    data.projects = data.projects || [];
                    data.tasks = data.tasks || [];
                    data.transactions = data.transactions || [];
                    data.trash = data.trash || [];
                    data.permanentlyDeleted = data.permanentlyDeleted || [];
                    data.settings = data.settings || {
                        nightMode: false,
                        currency: 'USD',
                        contrast: 'normal',
                        fontSize: 'm',
                        saturation: 'normal',
                        theme: 'rose',
                        aiEnabled: true
                    };
                    // Ensure theme setting exists
                    if (!data.settings.theme) {
                        data.settings.theme = 'rose';
                    }
                    if (data.settings.aiEnabled === undefined) {
                        data.settings.aiEnabled = true;
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('builderProData', JSON.stringify(data));
        }

        // Clear all data
        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will permanently delete ALL projects, tasks, and transactions. Are you absolutely sure?')) {
                data = {
                    projects: [],
                    tasks: [],
                    transactions: [],
                    trash: [],
                    permanentlyDeleted: [],
                    settings: data.settings // Preserve settings
                };
                saveData();
                renderView();
                updateStats();
                showToast('‚ú® All data cleared! Fresh start.');
            }
        }
        
        // Apply settings
        function applySettings() {
            document.body.classList.toggle('night-mode', data.settings.nightMode);
            
            // Remove all theme classes
            document.body.classList.remove('theme-rose', 'theme-sage', 'theme-gold', 
                                          'theme-ocean', 'theme-lavender', 'theme-teal', 'theme-seafoam');
            // Add current theme
            document.body.classList.add('theme-' + data.settings.theme);
            
            // Update theme color meta tag
            const themeColors = {
                rose: '#d2bcbf',
                sage: '#c0ccb8',
                gold: '#e0b558',
                ocean: '#99b3ec',
                lavender: '#8386a4',
                teal: '#90b2b8',
                seafoam: '#9cbbbf'
            };
            document.querySelector('meta[name="theme-color"]').content = themeColors[data.settings.theme];
            
            // Contrast settings
            document.body.classList.remove('low-contrast', 'normal-contrast', 'high-contrast', 'extra-contrast');
            document.body.classList.add(data.settings.contrast + '-contrast');
            
            // Font size settings
            document.body.classList.remove('font-s', 'font-m', 'font-l', 'font-xl', 'font-xxl');
            document.body.classList.add('font-' + data.settings.fontSize);
            
            // Saturation settings
            document.body.classList.remove('sat-low', 'sat-normal', 'sat-high', 'sat-vibrant');
            document.body.classList.add('sat-' + data.settings.saturation);
            
            // AI Assistant visibility
            document.querySelector('.ai-assistant').style.display = data.settings.aiEnabled ? 'flex' : 'none';
        }
        
        // Switch view
        function switchView(view) {
            currentView = view;
            
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(view + 'Section').classList.add('active');
            
            // Update add button visibility
            document.getElementById('addBtn').style.display = 
                (view === 'settings' || view === 'schedule') ? 'none' : 'block';
            
            renderView();
        }
        
        // Go home
        function goHome() {
            currentView = 'projects';
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector('.nav-tab').classList.add('active');
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('projectsSection').classList.add('active');
            
            renderView();
        }
        
        // Render current view
        function renderView() {
            switch(currentView) {
                case 'projects':
                    renderProjects();
                    break;
                case 'schedule':
                    renderSchedule();
                    break;
                case 'tasks':
                    renderTasks();
                    break;
                case 'financial':
                    renderFinancial();
                    break;
                case 'settings':
                    renderSettings();
                    break;
            }
        }
        
        // Render projects with mini Gantt charts
        function renderProjects() {
            const container = document.getElementById('projectsSection');
            const projects = data.projects.filter(p => !p.deleted);
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÅ</div>
                        <div class="empty-text">No projects yet<br>Tap + to create your first project</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = projects.map(project => {
                const tasks = data.tasks.filter(t => t.projectId === project.id && !t.deleted);
                const completed = tasks.filter(t => t.completed).length;
                const progress = tasks.length > 0 ? (completed / tasks.length * 100) : 0;
                
                const transactions = data.transactions.filter(t => t.projectId === project.id && !t.deleted);
                const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const balance = income - expenses;
                
                // Calculate project duration for mini Gantt
                const startDate = new Date(project.startDate || project.created);
                const endDate = new Date(project.endDate || Date.now() + 30 * 24 * 60 * 60 * 1000);
                const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                const daysPassed = Math.ceil((new Date() - startDate) / (1000 * 60 * 60 * 24));
                const progressPercent = Math.min(100, Math.max(0, (daysPassed / totalDays) * 100));
                
                return `
                    <div class="card" onclick="viewProject('${project.id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title">
                                    ${project.name}
                                    ${project.priority === 'high' ? '<span class="ai-priority high">HIGH</span>' : ''}
                                    ${project.priority === 'low' ? '<span class="ai-priority low">LOW</span>' : ''}
                                </div>
                                <div class="card-meta">
                                    ${tasks.length} tasks ‚Ä¢ ${getCurrencySymbol()}${balance.toFixed(2)}
                                    ${project.budget ? ` ‚Ä¢ Budget: ${getCurrencySymbol()}${project.budget}` : ''}
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn" onclick="event.stopPropagation(); deleteProject('${project.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        ${project.description ? `<div class="card-meta">${project.description}</div>` : ''}
                        
                        <!-- Mini Gantt Chart -->
                        <div class="mini-gantt">
                            <div class="mini-gantt-bar" style="width: ${progressPercent}%; background: ${getProjectColor(project.id)};"></div>
                            <div style="position: absolute; top: 20px; left: 8px; font-size: 10px; color: var(--text-secondary);">
                                ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - 
                                ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                            </div>
                        </div>
                        
                        ${tasks.length > 0 ? `
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Render Schedule with main Gantt chart
        function renderSchedule() {
            const container = document.getElementById('scheduleSection');
            const projects = data.projects.filter(p => !p.deleted);
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <div class="empty-text">No projects to schedule<br>Create projects to see your timeline</div>
                    </div>
                `;
                return;
            }
            
            // Generate Gantt chart HTML
            const months = generateMonthRange(projects);
            const ganttHTML = `
                <div class="gantt-container">
                    <div class="gantt-header">
                        <div class="gantt-title">üìä Master Schedule</div>
                        <div class="gantt-controls">
                            <button class="gantt-btn ${ganttView === 'day' ? 'active' : ''}" onclick="changeGanttView('day')">Day</button>
                            <button class="gantt-btn ${ganttView === 'week' ? 'active' : ''}" onclick="changeGanttView('week')">Week</button>
                            <button class="gantt-btn ${ganttView === 'month' ? 'active' : ''}" onclick="changeGanttView('month')">Month</button>
                        </div>
                    </div>
                    <div class="gantt-chart">
                        <div class="gantt-timeline">
                            ${months.map(month => `<div class="gantt-month">${month}</div>`).join('')}
                        </div>
                        <div class="gantt-rows">
                            ${projects.map(project => {
                                const startDate = new Date(project.startDate || project.created);
                                const endDate = new Date(project.endDate || Date.now() + 30 * 24 * 60 * 60 * 1000);
                                const position = calculateGanttPosition(startDate, endDate, months);
                                
                                return `
                                    <div class="gantt-row">
                                        <div class="gantt-label">${project.name}</div>
                                        <div class="gantt-bars">
                                            <div class="gantt-bar ${project.priority === 'high' ? 'critical' : ''}" 
                                                 style="left: ${position.left}%; width: ${position.width}%; background: ${getProjectColor(project.id)};"
                                                 onclick="viewProject('${project.id}')">
                                                ${Math.round(position.width) > 10 ? project.name.substring(0, 10) : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- AI Schedule Insights -->
                ${renderScheduleInsights(projects)}
            `;
            
            container.innerHTML = ganttHTML;
        }

        // Generate month range for Gantt chart
        function generateMonthRange(projects) {
            if (projects.length === 0) return [];
            
            let minDate = new Date();
            let maxDate = new Date();
            
            projects.forEach(project => {
                const start = new Date(project.startDate || project.created);
                const end = new Date(project.endDate || Date.now() + 30 * 24 * 60 * 60 * 1000);
                
                if (start < minDate) minDate = start;
                if (end > maxDate) maxDate = end;
            });
            
            // Add buffer
            minDate.setMonth(minDate.getMonth() - 1);
            maxDate.setMonth(maxDate.getMonth() + 1);
            
            const months = [];
            const current = new Date(minDate);
            
            while (current <= maxDate) {
                months.push(current.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
                current.setMonth(current.getMonth() + 1);
            }
            
            return months;
        }

        // Calculate Gantt bar position
        function calculateGanttPosition(startDate, endDate, months) {
            if (months.length === 0) return { left: 0, width: 100 };
            
            const firstMonth = new Date(months[0]);
            const lastMonth = new Date(months[months.length - 1]);
            const totalDays = (lastMonth - firstMonth) / (1000 * 60 * 60 * 24);
            
            const startOffset = Math.max(0, (startDate - firstMonth) / (1000 * 60 * 60 * 24));
            const duration = (endDate - startDate) / (1000 * 60 * 60 * 24);
            
            return {
                left: (startOffset / totalDays) * 100,
                width: Math.min(100 - (startOffset / totalDays) * 100, (duration / totalDays) * 100)
            };
        }

        // Get project color
        function getProjectColor(projectId) {
            const colors = [
                'var(--gantt-project1)',
                'var(--gantt-project2)',
                'var(--gantt-project3)',
                'var(--gantt-project4)',
                'var(--gantt-project5)',
                'var(--gantt-project6)'
            ];
            const index = data.projects.findIndex(p => p.id === projectId);
            return colors[index % colors.length];
        }

        // Change Gantt view
        function changeGanttView(view) {
            ganttView = view;
            renderSchedule();
        }

        // Render schedule insights
        function renderScheduleInsights(projects) {
            const today = new Date();
            const overdue = projects.filter(p => new Date(p.endDate) < today && !isProjectComplete(p.id));
            const upcoming = projects.filter(p => {
                const end = new Date(p.endDate);
                const daysUntil = (end - today) / (1000 * 60 * 60 * 24);
                return daysUntil > 0 && daysUntil <= 7;
            });
            
            if (overdue.length === 0 && upcoming.length === 0) return '';
            
            return `
                <div class="card">
                    <div class="card-title">ü§ñ AI Schedule Insights</div>
                    ${overdue.length > 0 ? `
                        <div class="ai-suggestion">
                            <div class="ai-suggestion-title">‚ö†Ô∏è Overdue Projects (${overdue.length})</div>
                            <div class="ai-suggestion-desc">
                                ${overdue.map(p => p.name).join(', ')} need immediate attention.
                            </div>
                        </div>
                    ` : ''}
                    ${upcoming.length > 0 ? `
                        <div class="ai-suggestion">
                            <div class="ai-suggestion-title">üìÖ Upcoming Deadlines (${upcoming.length})</div>
                            <div class="ai-suggestion-desc">
                                ${upcoming.map(p => p.name).join(', ')} are due within 7 days.
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Check if project is complete
        function isProjectComplete(projectId) {
            const tasks = data.tasks.filter(t => t.projectId === projectId && !t.deleted);
            if (tasks.length === 0) return false;
            return tasks.every(t => t.completed);
        }

        // Initialize AI
        function initializeAI() {
            generateAISuggestions();
            
            // Refresh AI suggestions every 5 minutes
            setInterval(generateAISuggestions, 5 * 60 * 1000);
        }

        // Generate AI suggestions
        function generateAISuggestions() {
            const suggestions = [];
            const projects = data.projects.filter(p => !p.deleted);
            const tasks = data.tasks.filter(t => !t.deleted);
            
            // Analyze project health
            projects.forEach(project => {
                const projectTasks = tasks.filter(t => t.projectId === project.id);
                const completedTasks = projectTasks.filter(t => t.completed);
                const progress = projectTasks.length > 0 ? (completedTasks.length / projectTasks.length) * 100 : 0;
                
                // Check if project is behind schedule
                if (project.endDate) {
                    const daysRemaining = Math.ceil((new Date(project.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                    const estimatedDaysNeeded = projectTasks.filter(t => !t.completed).length * 2; // Assume 2 days per task
                    
                    if (daysRemaining < estimatedDaysNeeded && progress < 80) {
                        suggestions.push({
                            title: `${project.name} is at risk`,
                            desc: `Only ${daysRemaining} days left with ${projectTasks.filter(t => !t.completed).length} tasks remaining. Consider reassigning resources.`,
                            priority: 'high',
                            action: () => viewProject(project.id)
                        });
                    }
                }
                
                // Suggest adding tasks to empty projects
                if (projectTasks.length === 0) {
                    suggestions.push({
                        title: `Add tasks to ${project.name}`,
                        desc: 'Projects without tasks are harder to track. Break down the work into manageable tasks.',
                        priority: 'medium',
                        action: () => openAddTaskForProject(project.id)
                    });
                }
                
                // Budget warnings
                const transactions = data.transactions.filter(t => t.projectId === project.id && !t.deleted);
                const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                if (project.budget && expenses > project.budget * 0.8) {
                    suggestions.push({
                        title: `Budget alert for ${project.name}`,
                        desc: `You've used ${Math.round((expenses / project.budget) * 100)}% of your budget.`,
                        priority: expenses > project.budget ? 'high' : 'medium',
                        action: () => viewProject(project.id)
                    });
                }
            });
            
            // Task optimization suggestions
            const overdueTasks = tasks.filter(t => t.dueDate && new Date(t.dueDate) < new Date() && !t.completed);
            if (overdueTasks.length > 0) {
                suggestions.push({
                    title: `${overdueTasks.length} overdue tasks`,
                    desc: 'Focus on completing overdue tasks to get back on track.',
                    priority: 'high',
                    action: () => switchView('tasks')
                });
            }
            
            // Workload balancing
            const tasksPerProject = {};
            tasks.forEach(task => {
                if (!task.completed) {
                    tasksPerProject[task.projectId] = (tasksPerProject[task.projectId] || 0) + 1;
                }
            });
            
            const imbalanced = Object.values(tasksPerProject).some(count => count > 10);
            if (imbalanced) {
                suggestions.push({
                    title: 'Workload imbalance detected',
                    desc: 'Some projects have too many pending tasks. Consider breaking them down or delegating.',
                    priority: 'low',
                    action: () => switchView('schedule')
                });
            }
            
            // Update AI panel
            updateAISuggestions(suggestions);
        }

        // Update AI suggestions panel
        function updateAISuggestions(suggestions) {
            const container = document.getElementById('aiSuggestions');
            
            if (suggestions.length === 0) {
                container.innerHTML = `
                    <div class="ai-suggestion">
                        <div class="ai-suggestion-title">‚ú® All looking good!</div>
                        <div class="ai-suggestion-desc">Your projects are on track. Keep up the great work!</div>
                    </div>
                `;
                return;
            }
            
            // Sort by priority
            suggestions.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            container.innerHTML = suggestions.slice(0, 5).map(suggestion => `
                <div class="ai-suggestion" onclick="${suggestion.action ? 'executeSuggestion(' + suggestions.indexOf(suggestion) + ')' : ''}">
                    <div class="ai-suggestion-title">
                        ${suggestion.title}
                        <span class="ai-priority ${suggestion.priority}">${suggestion.priority.toUpperCase()}</span>
                    </div>
                    <div class="ai-suggestion-desc">${suggestion.desc}</div>
                </div>
            `).join('');
            
            // Store suggestions for execution
            window.aiSuggestions = suggestions;
        }

        // Execute AI suggestion
        function executeSuggestion(index) {
            if (window.aiSuggestions && window.aiSuggestions[index] && window.aiSuggestions[index].action) {
                window.aiSuggestions[index].action();
                toggleAIPanel();
            }
        }

        // Toggle AI panel
        function toggleAIPanel() {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                generateAISuggestions();
            }
        }

        // Show AI Assistant
        function showAIAssistant() {
            generateAISuggestions();
            toggleAIPanel();
        }
        
        // View project details
        function viewProject(projectId) {
            const project = data.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const tasks = data.tasks.filter(t => t.projectId === projectId && !t.deleted);
            const transactions = data.transactions.filter(t => t.projectId === projectId && !t.deleted);
            
            const container = document.getElementById('projectsSection');
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">
                                ${project.name}
                                ${project.priority === 'high' ? '<span class="ai-priority high">HIGH</span>' : ''}
                                ${project.priority === 'low' ? '<span class="ai-priority low">LOW</span>' : ''}
                            </div>
                            <div class="card-meta">
                                Created: ${new Date(project.created).toLocaleDateString()}
                                ${project.startDate ? ` ‚Ä¢ Start: ${new Date(project.startDate).toLocaleDateString()}` : ''}
                                ${project.endDate ? ` ‚Ä¢ End: ${new Date(project.endDate).toLocaleDateString()}` : ''}
                            </div>
                        </div>
                        <button class="card-btn" onclick="renderProjects()">‚Üê</button>
                    </div>
                    ${project.description ? `<div class="card-meta">${project.description}</div>` : ''}
                    
                    <!-- Project Mini Gantt -->
                    <div class="mini-gantt" style="height: 100px; margin-top: 10px;">
                        ${renderProjectGantt(project, tasks)}
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Tasks (${tasks.length})</div>
                    ${tasks.length > 0 ? tasks.map(task => `
                        <div class="task-item">
                            <input type="checkbox" class="task-checkbox" 
                                   ${task.completed ? 'checked' : ''} 
                                   onchange="toggleTask('${task.id}')">
                            <span class="task-text ${task.completed ? 'completed' : ''}">
                                ${task.description}
                                ${task.dueDate ? ` (Due: ${new Date(task.dueDate).toLocaleDateString()})` : ''}
                                ${task.estimatedHours ? ` [${task.estimatedHours}h]` : ''}
                            </span>
                            <button class="delete-task-btn" onclick="deleteTask('${task.id}')">√ó</button>
                        </div>
                    `).join('') : '<div class="card-meta">No tasks yet</div>'}
                    <button class="btn btn-primary" style="margin-top: 10px" 
                            onclick="openAddTaskForProject('${projectId}')">Add Task</button>
                </div>
                
                <div class="card">
                    <div class="card-title">Transactions</div>
                    ${transactions.length > 0 ? transactions.map(t => `
                        <div class="transaction-item">
                            <div>
                                <div class="${t.type}">${getCurrencySymbol()}${t.amount.toFixed(2)}</div>
                                <div class="card-meta">${t.description}</div>
                            </div>
                            <div class="card-meta">${new Date(t.date).toLocaleDateString()}</div>
                        </div>
                    `).join('') : '<div class="card-meta">No transactions yet</div>'}
                </div>
            `;
        }

        // Render project Gantt
        function renderProjectGantt(project, tasks) {
            if (tasks.length === 0) {
                return '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No tasks to display in timeline</div>';
            }
            
            const startDate = new Date(project.startDate || project.created);
            const endDate = new Date(project.endDate || Date.now() + 30 * 24 * 60 * 60 * 1000);
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            return tasks.map((task, index) => {
                const taskStart = new Date(task.created);
                const taskEnd = task.dueDate ? new Date(task.dueDate) : endDate;
                const taskStartOffset = Math.max(0, Math.ceil((taskStart - startDate) / (1000 * 60 * 60 * 24)));
                const taskDuration = Math.ceil((taskEnd - taskStart) / (1000 * 60 * 60 * 24));
                
                const left = (taskStartOffset / totalDays) * 100;
                const width = Math.min(100 - left, (taskDuration / totalDays) * 100);
                
                return `
                    <div style="position: absolute; 
                                left: ${left}%; 
                                width: ${width}%; 
                                top: ${10 + index * 15}px; 
                                height: 12px; 
                                background: ${task.completed ? '#10b981' : '#f39c12'}; 
                                border-radius: 2px; 
                                opacity: 0.8;
                                font-size: 9px;
                                color: white;
                                padding: 0 2px;
                                overflow: hidden;">
                        ${task.description.substring(0, 10)}
                    </div>
                `;
            }).join('');
        }
        
        // Render tasks
        function renderTasks() {
            const container = document.getElementById('tasksSection');
            const tasks = data.tasks.filter(t => !t.deleted);
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <div class="empty-text">No tasks yet<br>Create a project first, then add tasks</div>
                    </div>
                `;
                return;
            }
            
            // Group tasks by project
            const grouped = {};
            tasks.forEach(task => {
                const project = data.projects.find(p => p.id === task.projectId);
                if (project) {
                    if (!grouped[project.name]) {
                        grouped[project.name] = [];
                    }
                    grouped[project.name].push(task);
                }
            });
            
            container.innerHTML = Object.entries(grouped).map(([projectName, tasks]) => `
                <div class="card">
                    <div class="card-title">${projectName}</div>
                    ${tasks.map(task => `
                        <div class="task-item">
                            <input type="checkbox" class="task-checkbox" 
                                   ${task.completed ? 'checked' : ''} 
                                   onchange="toggleTask('${task.id}')">
                            <span class="task-text ${task.completed ? 'completed' : ''}">
                                ${task.description}
                                ${task.dueDate ? ` (Due: ${new Date(task.dueDate).toLocaleDateString()})` : ''}
                                ${task.estimatedHours ? ` [${task.estimatedHours}h]` : ''}
                            </span>
                            <button class="delete-task-btn" onclick="deleteTask('${task.id}')">√ó</button>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
        
        // Render financial
        function renderFinancial() {
            const container = document.getElementById('financialSection');
            const transactions = data.transactions.filter(t => !t.deleted);
            
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpenses;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-title">Summary</div>
                    <div class="transaction-item">
                        <span>Total Income</span>
                        <span class="income">${getCurrencySymbol()}${totalIncome.toFixed(2)}</span>
                    </div>
                    <div class="transaction-item">
                        <span>Total Expenses</span>
                        <span class="expense">${getCurrencySymbol()}${totalExpenses.toFixed(2)}</span>
                    </div>
                    <div class="transaction-item">
                        <span><strong>Balance</strong></span>
                        <span class="${balance >= 0 ? 'income' : 'expense'}">
                            <strong>${getCurrencySymbol()}${balance.toFixed(2)}</strong>
                        </span>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">Recent Transactions</div>
                    ${transactions.length > 0 ? transactions.slice(-10).reverse().map(t => {
                        const project = data.projects.find(p => p.id === t.projectId);
                        return `
                            <div class="transaction-item">
                                <div>
                                    <div class="${t.type}">${getCurrencySymbol()}${t.amount.toFixed(2)}</div>
                                    <div class="card-meta">${t.description}</div>
                                    ${project ? `<div class="card-meta">${project.name}</div>` : ''}
                                </div>
                                <div>
                                    <div class="card-meta">${new Date(t.date).toLocaleDateString()}</div>
                                    <button class="card-btn" onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('') : '<div class="card-meta">No transactions yet</div>'}
                </div>
            `;
        }
        
        // Render settings
        function renderSettings() {
            const container = document.getElementById('settingsSection');
            container.innerHTML = `
                <div class="settings-group">
                    <div class="settings-row">
                        <span class="settings-label">Night Mode</span>
                        <div class="switch ${data.settings.nightMode ? 'active' : ''}" 
                             onclick="toggleSetting('nightMode')">
                            <div class="switch-handle"></div>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-label">AI Assistant</span>
                        <div class="switch ${data.settings.aiEnabled ? 'active' : ''}" 
                             onclick="toggleSetting('aiEnabled')">
                            <div class="switch-handle"></div>
                        </div>
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-label">Theme Color</span>
                    </div>
                    <div class="theme-picker">
                        <div class="theme-option ${data.settings.theme === 'rose' ? 'active' : ''}" 
                             data-theme="rose" onclick="setTheme('rose')"></div>
                        <div class="theme-option ${data.settings.theme === 'sage' ? 'active' : ''}" 
                             data-theme="sage" onclick="setTheme('sage')"></div>
                        <div class="theme-option ${data.settings.theme === 'gold' ? 'active' : ''}" 
                             data-theme="gold" onclick="setTheme('gold')"></div>
                        <div class="theme-option ${data.settings.theme === 'ocean' ? 'active' : ''}" 
                             data-theme="ocean" onclick="setTheme('ocean')"></div>
                        <div class="theme-option ${data.settings.theme === 'lavender' ? 'active' : ''}" 
                             data-theme="lavender" onclick="setTheme('lavender')"></div>
                        <div class="theme-option ${data.settings.theme === 'teal' ? 'active' : ''}" 
                             data-theme="teal" onclick="setTheme('teal')"></div>
                        <div class="theme-option ${data.settings.theme === 'seafoam' ? 'active' : ''}" 
                             data-theme="seafoam" onclick="setTheme('seafoam')"></div>
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-label">Contrast</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn-option ${data.settings.contrast === 'low' ? 'active' : ''}" 
                                onclick="setSetting('contrast', 'low')">Low</button>
                        <button class="btn-option ${data.settings.contrast === 'normal' ? 'active' : ''}" 
                                onclick="setSetting('contrast', 'normal')">Normal</button>
                        <button class="btn-option ${data.settings.contrast === 'high' ? 'active' : ''}" 
                                onclick="setSetting('contrast', 'high')">High</button>
                        <button class="btn-option ${data.settings.contrast === 'extra' ? 'active' : ''}" 
                                onclick="setSetting('contrast', 'extra')">Extra</button>
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-label">Font Size</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn-option ${data.settings.fontSize === 's' ? 'active' : ''}" 
                                onclick="setSetting('fontSize', 's')">S</button>
                        <button class="btn-option ${data.settings.fontSize === 'm' ? 'active' : ''}" 
                                onclick="setSetting('fontSize', 'm')">M</button>
                        <button class="btn-option ${data.settings.fontSize === 'l' ? 'active' : ''}" 
                                onclick="setSetting('fontSize', 'l')">L</button>
                        <button class="btn-option ${data.settings.fontSize === 'xl' ? 'active' : ''}" 
                                onclick="setSetting('fontSize', 'xl')">XL</button>
                        <button class="btn-option ${data.settings.fontSize === 'xxl' ? 'active' : ''}" 
                                onclick="setSetting('fontSize', 'xxl')">XXL</button>
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-label">Color Saturation</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn-option ${data.settings.saturation === 'low' ? 'active' : ''}" 
                                onclick="setSetting('saturation', 'low')">Low</button>
                        <button class="btn-option ${data.settings.saturation === 'normal' ? 'active' : ''}" 
                                onclick="setSetting('saturation', 'normal')">Normal</button>
                        <button class="btn-option ${data.settings.saturation === 'high' ? 'active' : ''}" 
                                onclick="setSetting('saturation', 'high')">High</button>
                        <button class="btn-option ${data.settings.saturation === 'vibrant' ? 'active' : ''}" 
                                onclick="setSetting('saturation', 'vibrant')">Vibrant</button>
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-label">Currency</span>
                        <select class="form-select" style="width: auto" onchange="setCurrency(this.value)">
                            <option value="USD" ${data.settings.currency === 'USD' ? 'selected' : ''}>USD ($)</option>
                            <option value="EUR" ${data.settings.currency === 'EUR' ? 'selected' : ''}>EUR (‚Ç¨)</option>
                            <option value="GBP" ${data.settings.currency === 'GBP' ? 'selected' : ''}>GBP (¬£)</option>
                            <option value="JPY" ${data.settings.currency === 'JPY' ? 'selected' : ''}>JPY (¬•)</option>
                            <option value="CNY" ${data.settings.currency === 'CNY' ? 'selected' : ''}>CNY (¬•)</option>
                            <option value="INR" ${data.settings.currency === 'INR' ? 'selected' : ''}>INR (‚Çπ)</option>
                            <option value="MYR" ${data.settings.currency === 'MYR' ? 'selected' : ''}>MYR (RM)</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="card-title">Cloud Sync (JSONBin.io)</div>
                    <div id="syncStatus">
                        <div>Status: <span id="syncMode">Not configured</span></div>
                        <div id="lastSyncTime"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Key (from jsonbin.io)</label>
                        <input type="password" class="form-input" id="apiKeyInput" 
                               placeholder="Enter your JSONBin API key">
                    </div>
                    <button class="btn btn-primary" onclick="saveApiKey()">Save API Key</button>
                    <button class="btn btn-secondary" onclick="testSync()" style="margin-top: 8px">Test Connection</button>
                </div>
                
                <div class="settings-group">
                    <div class="card-title">Data Management</div>
                    <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none" onchange="importData(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" 
                            style="margin-top: 8px">Import Data</button>
                    <button class="btn btn-secondary" onclick="showTrash()" style="margin-top: 8px">
                        View Trash (${data.trash.length} items)
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()" style="margin-top: 8px">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>
                
                <div class="settings-group">
                    <div class="card-title">About</div>
                    <div class="card-meta">
                        Builder Pro AI v2.1<br>
                        Intelligent Project Manager<br>
                        ¬© 2025 - All rights reserved
                    </div>
                </div>
            `;
        }
        
        // Toggle setting
        function toggleSetting(setting) {
            data.settings[setting] = !data.settings[setting];
            saveData();
            applySettings();
            renderSettings();
            
            if (setting === 'aiEnabled') {
                if (data.settings.aiEnabled) {
                    initializeAI();
                    showToast('ü§ñ AI Assistant activated');
                } else {
                    showToast('AI Assistant deactivated');
                }
            }
        }
        
        // Set setting
        function setSetting(setting, value) {
            data.settings[setting] = value;
            saveData();
            applySettings();
            renderSettings();
        }
        
        // Set theme
        function setTheme(theme) {
            data.settings.theme = theme;
            saveData();
            applySettings();
            renderSettings();
        }
        
        // Set currency
        function setCurrency(currency) {
            data.settings.currency = currency;
            saveData();
            renderView();
            updateStats();
        }
        
        // Get currency symbol
        function getCurrencySymbol() {
            const symbols = {
                USD: '$',
                EUR: '‚Ç¨',
                GBP: '¬£',
                JPY: '¬•',
                CNY: '¬•',
                INR: '‚Çπ',
                MYR: 'RM'
            };
            return symbols[data.settings.currency] || '$';
        }
        
        // Update stats
        function updateStats() {
            const projects = data.projects.filter(p => !p.deleted);
            const tasks = data.tasks.filter(t => !t.deleted);
            const completedTasks = tasks.filter(t => t.completed);
            const transactions = data.transactions.filter(t => !t.deleted);
            
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpenses;
            
            document.getElementById('projectCount').textContent = projects.length;
            document.getElementById('taskCount').textContent = tasks.length;
            document.getElementById('completionRate').textContent = 
                tasks.length > 0 ? Math.round(completedTasks.length / tasks.length * 100) + '%' : '0%';
            document.getElementById('totalBalance').textContent = 
                getCurrencySymbol() + balance.toFixed(0);
        }
        
        // Open add modal
        function openAddModal() {
            switch(currentView) {
                case 'projects':
                    openModal('addProjectModal');
                    document.getElementById('currencyDisplay').textContent = data.settings.currency;
                    // Set default dates
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('projectStartDate').value = today;
                    const endDate = new Date();
                    endDate.setMonth(endDate.getMonth() + 1);
                    document.getElementById('projectEndDate').value = endDate.toISOString().split('T')[0];
                    break;
                case 'tasks':
                    if (data.projects.filter(p => !p.deleted).length === 0) {
                        showToast('Create a project first');
                        return;
                    }
                    openAddTaskModal();
                    break;
                case 'financial':
                    openAddTransactionModal();
                    break;
            }
        }
        
        // Open add task modal
        function openAddTaskModal() {
            const select = document.getElementById('taskProject');
            select.innerHTML = data.projects.filter(p => !p.deleted).map(p => 
                `<option value="${p.id}">${p.name}</option>`
            ).join('');
            openModal('addTaskModal');
        }
        
        // Open add task for specific project
        function openAddTaskForProject(projectId) {
            const select = document.getElementById('taskProject');
            select.innerHTML = data.projects.filter(p => !p.deleted).map(p => 
                `<option value="${p.id}" ${p.id === projectId ? 'selected' : ''}>${p.name}</option>`
            ).join('');
            openModal('addTaskModal');
        }
        
        // Open add transaction modal
        function openAddTransactionModal() {
            const select = document.getElementById('transactionProject');
            select.innerHTML = '<option value="">No Project</option>' + 
                data.projects.filter(p => !p.deleted).map(p => 
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
            openModal('addTransactionModal');
        }
        
        // Open modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Clear inputs
            document.querySelectorAll(`#${modalId} input, #${modalId} textarea`).forEach(input => {
                if (input.type !== 'date') {
                    input.value = '';
                }
            });
        }
        
        // Save project
        function saveProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            const startDate = document.getElementById('projectStartDate').value;
            const endDate = document.getElementById('projectEndDate').value;
            const budget = parseFloat(document.getElementById('projectBudget').value) || 0;
            const priority = document.getElementById('projectPriority').value;
            
            if (!name) {
                showToast('Please enter a project name');
                return;
            }
            
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                showToast('End date must be after start date');
                return;
            }
            
            const project = {
                id: Date.now().toString(),
                name,
                description,
                startDate,
                endDate,
                budget,
                priority,
                created: Date.now(),
                updated: Date.now()
            };
            
            data.projects.push(project);
            saveData();
            closeModal('addProjectModal');
            renderProjects();
            updateStats();
            generateAISuggestions();
            showToast('üéâ Project created');
        }
        
        // Save task
        function saveTask() {
            const description = document.getElementById('taskDescription').value.trim();
            const projectId = document.getElementById('taskProject').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const estimatedHours = parseFloat(document.getElementById('taskEstimatedHours').value) || 0;
            
            if (!description) {
                showToast('Please enter task description');
                return;
            }
            
            const task = {
                id: Date.now().toString(),
                description,
                projectId,
                dueDate,
                estimatedHours,
                completed: false,
                created: Date.now(),
                updated: Date.now()
            };
            
            data.tasks.push(task);
            saveData();
            closeModal('addTaskModal');
            renderView();
            updateStats();
            generateAISuggestions();
            showToast('Task added');
        }
        
        // Save transaction
        function saveTransaction() {
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value.trim();
            const projectId = document.getElementById('transactionProject').value;
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount');
                return;
            }
            
            if (!description) {
                showToast('Please enter a description');
                return;
            }
            
            const transaction = {
                id: Date.now().toString(),
                type,
                amount,
                description,
                projectId,
                date: Date.now()
            };
            
            data.transactions.push(transaction);
            saveData();
            closeModal('addTransactionModal');
            renderFinancial();
            updateStats();
            generateAISuggestions();
            showToast('Transaction added');
        }
        
        // Toggle task
        function toggleTask(taskId) {
            const task = data.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                task.updated = Date.now();
                saveData();
                renderView();
                updateStats();
                generateAISuggestions();
            }
        }
        
        // Delete project
        function deleteProject(projectId) {
            if (!confirm('Delete this project and all its tasks/transactions?')) return;
            
            const project = data.projects.find(p => p.id === projectId);
            if (project) {
                project.deleted = true;
                project.deletedAt = Date.now();
                data.trash.push({ type: 'project', item: project });
                
                // Also delete related tasks and transactions
                data.tasks.filter(t => t.projectId === projectId).forEach(task => {
                    task.deleted = true;
                    task.deletedAt = Date.now();
                    data.trash.push({ type: 'task', item: task });
                });
                
                data.transactions.filter(t => t.projectId === projectId).forEach(transaction => {
                    transaction.deleted = true;
                    transaction.deletedAt = Date.now();
                    data.trash.push({ type: 'transaction', item: transaction });
                });
                
                saveData();
                renderProjects();
                updateStats();
                generateAISuggestions();
                showToast('Project moved to trash');
            }
        }
        
        // Delete task
        function deleteTask(taskId) {
            const task = data.tasks.find(t => t.id === taskId);
            if (task) {
                task.deleted = true;
                task.deletedAt = Date.now();
                data.trash.push({ type: 'task', item: task });
                saveData();
                renderView();
                updateStats();
                generateAISuggestions();
                showToast('Task deleted');
            }
        }
        
        // Delete transaction
        function deleteTransaction(transactionId) {
            const transaction = data.transactions.find(t => t.id === transactionId);
            if (transaction) {
                transaction.deleted = true;
                transaction.deletedAt = Date.now();
                data.trash.push({ type: 'transaction', item: transaction });
                saveData();
                renderFinancial();
                updateStats();
                showToast('Transaction deleted');
            }
        }
        
        // Show trash
        function showTrash() {
            const modal = document.getElementById('trashModal');
            const content = document.getElementById('trashContent');
            
            if (data.trash.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-text">Trash is empty</div></div>';
            } else {
                content.innerHTML = data.trash.map(item => {
                    const deletedDate = new Date(item.item.deletedAt).toLocaleDateString();
                    return `
                        <div class="task-item">
                            <div style="flex: 1">
                                <div>${item.type}: ${item.item.name || item.item.description}</div>
                                <div class="card-meta">Deleted: ${deletedDate}</div>
                            </div>
                            <button class="btn btn-primary" onclick="restoreItem('${item.item.id}', '${item.type}')">
                                Restore
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            openModal('trashModal');
        }
        
        // Restore item
        function restoreItem(itemId, type) {
            let item;
            switch(type) {
                case 'project':
                    item = data.projects.find(p => p.id === itemId);
                    break;
                case 'task':
                    item = data.tasks.find(t => t.id === itemId);
                    break;
                case 'transaction':
                    item = data.transactions.find(t => t.id === itemId);
                    break;
            }
            
            if (item) {
                delete item.deleted;
                delete item.deletedAt;
                data.trash = data.trash.filter(t => t.item.id !== itemId);
                saveData();
                showTrash();
                renderView();
                updateStats();
                showToast('Item restored');
            }
        }
        
        // Empty trash
        function emptyTrash() {
            if (!confirm('Permanently delete all items in trash?')) return;
            
            // Move items to permanently deleted for record keeping
            data.trash.forEach(item => {
                data.permanentlyDeleted.push({
                    ...item,
                    permanentlyDeletedAt: Date.now()
                });
            });
            
            // Remove from main arrays
            const trashIds = data.trash.map(t => t.item.id);
            data.projects = data.projects.filter(p => !trashIds.includes(p.id));
            data.tasks = data.tasks.filter(t => !trashIds.includes(t.id));
            data.transactions = data.transactions.filter(t => !trashIds.includes(t.id));
            
            data.trash = [];
            saveData();
            closeModal('trashModal');
            renderView();
            updateStats();
            showToast('Trash emptied');
        }
        
        // Show toast
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // Check sync status
        function checkSyncStatus() {
            const lastSync = localStorage.getItem('lastSyncTime');
            if (lastSync) {
                const date = new Date(parseInt(lastSync));
                document.getElementById('lastSyncTime').textContent = 
                    `Last: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            }
        }
        
        // Perform sync (temporarily disabled for Builder Pro 2.0 development)
        async function performSync() {
            if (apiTempDisabled) {
                showToast('üîß Sync temporarily disabled for Builder Pro AI development', 4000);
                return;
            }
            
            // [Sync implementation would go here - currently disabled]
            showToast('üîß Sync coming soon in next update');
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showToast('Please enter an API key');
                return;
            }
            
            syncApiKey = key;
            localStorage.setItem('builderProSyncApiKey', key);
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('syncMode').textContent = 'Ready';
            showToast('‚úÖ API key saved!');
        }

        async function testSync() {
            showToast('üîß Sync testing coming soon');
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'builder-pro-ai-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm('Replace all current data?')) {
                            data = imported;
                            saveData();
                            applySettings();
                            renderView();
                            updateStats();
                            showToast('Data imported');
                        }
                    } catch (error) {
                        showToast('Import failed');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Sticky Note Reminder System
        function setupReminderSystem() {
            // Temporarily disable API for Builder Pro 2.0 development
            apiTempDisabled = true;
            
            // Set random interval between 35-45 minutes
            const randomMinutes = 35 + Math.random() * 10; // 35-45 minutes
            const intervalMs = randomMinutes * 60 * 1000;
            
            reminderInterval = setInterval(() => {
                showStickyNote();
            }, intervalMs);
            
            // Show initial reminder after 2 minutes for testing
            setTimeout(() => {
                showStickyNote();
            }, 2 * 60 * 1000);
        }

        function showStickyNote() {
            const stickyNote = document.getElementById('stickyNote');
            const content = document.getElementById('stickyNoteContent');
            
            // Generate dynamic check items based on current app state
            const checkItems = [];
            
            // Check incomplete tasks
            const incompleteTasks = data.tasks.filter(t => !t.deleted && !t.completed).length;
            if (incompleteTasks > 0) {
                checkItems.push(`${incompleteTasks} pending task${incompleteTasks > 1 ? 's' : ''} to complete`);
            }
            
            // Check project progress
            const projectsWithNoTasks = data.projects.filter(p => {
                return !p.deleted && !data.tasks.some(t => t.projectId === p.id && !t.deleted);
            }).length;
            if (projectsWithNoTasks > 0) {
                checkItems.push(`${projectsWithNoTasks} project${projectsWithNoTasks > 1 ? 's' : ''} need tasks`);
            }
            
            // Check financial balance
            const transactions = data.transactions.filter(t => !t.deleted);
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpenses;
            if (balance < 0) {
                checkItems.push(`Budget deficit: ${getCurrencySymbol()}${Math.abs(balance).toFixed(0)}`);
            }
            
            // Check trash
            if (data.trash.length > 10) {
                checkItems.push(`Trash has ${data.trash.length} items`);
            }
            
            // Default items if nothing specific
            if (checkItems.length === 0) {
                checkItems.push('Review your schedule');
                checkItems.push('Check AI suggestions');
                checkItems.push('Update project timelines');
            }
            
            // Add development reminder
            checkItems.push('AI Assistant is ready to help! ü§ñ');
            
            // Generate HTML for check items
            content.innerHTML = checkItems.map(item => 
                `<div class="check-item">${item}</div>`
            ).join('');
            
            // Show sticky note
            stickyNote.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                stickyNote.classList.remove('show');
            }, 5000);
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
