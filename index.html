<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro">
    <meta name="apple-mobile-web-app-title" content="Builder Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#d2bcbf">
    <meta name="msapplication-navbutton-color" content="#d2bcbf">
    <meta name="msapplication-starturl" content="/">
    <meta name="format-detection" content="telephone=no">
    
    <title>Builder Pro - Complete Project Manager</title>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            
            --bg-color: #F4EDEB;
            --accent-color: #d2bcbf;
            --highlight-color: #a67980;
            --text-color: #1C1C1C;
            
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
        }
        
        /* Theme presets - Using body class for specificity */
        body.theme-rose {
            --accent-color: #d2bcbf !important;
            --highlight-color: #a67980 !important;
        }
        
        body.theme-sage {
            --accent-color: #c0ccb8 !important;
            --highlight-color: #60665c !important;
        }
        
        body.theme-gold {
            --accent-color: #e0b558 !important;
            --highlight-color: #ecd299 !important;
        }
        
        body.theme-ocean {
            --accent-color: #99b3ec !important;
            --highlight-color: #151b73 !important;
        }
        
        body.theme-slate {
            --accent-color: #8386a4 !important;
            --highlight-color: #191a22 !important;
        }
        
        body.theme-teal {
            --accent-color: #90b2b8 !important;
            --highlight-color: #2c4144 !important;
        }
        
        body.theme-mint {
            --accent-color: #9cbbbf !important;
            --highlight-color: #436266 !important;
        }
        
        body.low-contrast { --contrast: 0.85; --brightness: 1.1; }
        body.normal-contrast { --contrast: 1; --brightness: 1; }
        body.high-contrast { --contrast: 1.25; --brightness: 0.95; }
        body.extra-contrast { --contrast: 1.5; --brightness: 0.9; }
        body { filter: contrast(var(--contrast)) brightness(var(--brightness)); }
        
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.5; }

        body.sat-low { filter: saturate(0.7) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-normal { filter: saturate(1) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-high { filter: saturate(1.3) contrast(var(--contrast)) brightness(var(--brightness)); }
        body.sat-vibrant { filter: saturate(1.6) contrast(var(--contrast)) brightness(var(--brightness)); }

        .night-mode { 
            --bg-color: #1a1618 !important; 
            --card-bg: #2d2729 !important; 
            --text-color: #f0f0f0 !important; 
            --text-secondary: #c0c0c8 !important; 
            --border-color: #4a4246 !important; 
            --shadow-color: rgba(0,0,0,0.3) !important;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-color);
            min-height: 100vh; 
            overflow-x: hidden; 
            transition: all 0.3s; 
            font-size: calc(14px * var(--font-scale));
        }
        
        .app-container { 
            max-width: 100vw; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        @media (display-mode: standalone) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .main-content-wrapper {
                margin-top: calc(260px + max(20px, env(safe-area-inset-top)));
            }
        }
        
        @supports (padding-top: max(0px)) {
            .fixed-header-section {
                padding-top: max(20px, env(safe-area-inset-top));
            }
            
            .header {
                padding-top: 12px;
            }
        }
        
        .fixed-header-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: var(--bg-color);
            padding-top: var(--safe-area-inset-top);
        }
        
        .header { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            padding: 10px 12px; 
            box-shadow: 0 2px 10px var(--shadow-color); 
        }
        
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 10px; 
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .header h1 { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .header-subtitle { 
            font-size: calc(11px * var(--font-scale)); 
            opacity: 0.9; 
            margin-top: 2px; 
        }
        
        .header-controls { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: calc(14px * var(--font-scale)); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            transition: background 0.2s;
        }
        
        .header-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .sync-indicator { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 8px; 
            height: 8px; 
            background: #10b981; 
            border-radius: 50%; 
            display: none; 
        }
        
        .sync-indicator.syncing { 
            display: block; 
            animation: pulse 1.5s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { transform: scale(1); opacity: 1; } 
            50% { transform: scale(1.3); opacity: 0.7; } 
        }
        
        .stats-bar { 
            padding: 8px 12px; 
            background: var(--card-bg); 
            display: flex; 
            justify-content: space-around; 
            font-size: calc(11px * var(--font-scale)); 
            box-shadow: 0 2px 5px var(--shadow-color); 
            position: relative; 
        }
        
        .stat-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 2px; 
            padding: 0 5px; 
        }
        
        .stat-value { 
            font-size: calc(18px * var(--font-scale)); 
            font-weight: bold; 
            color: var(--accent-color); 
        }
        
        .stat-label { 
            color: var(--text-secondary); 
            font-size: calc(10px * var(--font-scale)); 
        }
        
        .quick-actions { 
            padding: 12px; 
            background: var(--card-bg); 
            margin-top: 2px; 
            box-shadow: 0 2px 5px var(--shadow-color); 
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }
        
        .quick-action-btn { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
            border: none; 
            padding: 8px 14px; 
            border-radius: 20px; 
            font-size: calc(13px * var(--font-scale)); 
            white-space: nowrap; 
            cursor: pointer; 
            transition: all 0.3s; 
            flex-shrink: 0; 
        }
        
        .quick-action-btn.active { 
            background: linear-gradient(135deg, var(--highlight-color) 0%, var(--accent-color) 100%); 
            box-shadow: 0 2px 8px var(--shadow-color); 
            transform: scale(1.05); 
        }
        
        .main-content-wrapper {
            margin-top: 260px;
            flex: 1;
            background: var(--bg-color);
        }
        
        .main-content { 
            padding: 12px; 
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        .project-card, .task-item, .transaction-item { 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 14px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 8px var(--shadow-color); 
            position: relative; 
            transition: all 0.3s; 
            cursor: pointer;
        }
        
        .project-card:active, .task-item:active, .transaction-item:active { 
            transform: scale(0.98); 
            box-shadow: 0 1px 4px var(--shadow-color); 
        }
        
        .project-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 10px; 
        }
        
        .project-title { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
            color: var(--text-color); 
        }
        
        .project-value { 
            font-size: calc(14px * var(--font-scale)); 
            font-weight: 600; 
            color: var(--success); 
        }
        
        .project-dates { 
            font-size: calc(11px * var(--font-scale)); 
            color: var(--text-secondary); 
            margin-bottom: 8px; 
        }
        
        .project-progress { 
            background: var(--border-color); 
            height: 4px; 
            border-radius: 2px; 
            overflow: hidden; 
            margin: 8px 0; 
        }
        
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, var(--accent-color), var(--highlight-color)); 
            border-radius: 2px; 
            transition: width 0.3s ease; 
        }
        
        .project-stats { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 10px; 
            padding-top: 10px; 
            border-top: 1px solid var(--border-color); 
            font-size: calc(11px * var(--font-scale)); 
        }
        
        .stat-group { 
            display: flex; 
            gap: 15px; 
        }
        
        .task-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 14px; 
        }
        
        .task-left { 
            flex: 1; 
        }
        
        .task-title { 
            font-size: calc(14px * var(--font-scale)); 
            color: var(--text-color); 
            margin-bottom: 2px; 
        }
        
        .task-project { 
            font-size: calc(11px * var(--font-scale)); 
            color: var(--text-secondary); 
        }
        
        .task-checkbox { 
            width: 22px; 
            height: 22px; 
            border: 2px solid var(--accent-color); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .task-checkbox.checked { 
            background: var(--accent-color); 
        }
        
        .task-checkbox.checked::after { 
            content: '‚úì'; 
            color: white; 
            font-size: calc(12px * var(--font-scale)); 
            font-weight: bold; 
        }
        
        .transaction-item { 
            padding: 10px 14px; 
        }
        
        .transaction-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 4px; 
        }
        
        .transaction-title { 
            font-size: calc(14px * var(--font-scale)); 
            font-weight: 500; 
        }
        
        .transaction-amount { 
            font-size: calc(16px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .transaction-amount.income { 
            color: var(--income-color); 
        }
        
        .transaction-amount.expense { 
            color: var(--expense-color); 
        }
        
        .transaction-details { 
            display: flex; 
            justify-content: space-between; 
            font-size: calc(11px * var(--font-scale)); 
            color: var(--text-secondary); 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            animation: fadeIn 0.3s;
        }
        
        .modal.active { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
        }
        
        .modal-content { 
            background: var(--card-bg); 
            border-radius: 16px; 
            max-width: 500px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto; 
            animation: slideUp 0.3s; 
        }
        
        @keyframes slideUp { 
            from { transform: translateY(50px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        .modal-header { 
            padding: 16px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-title { 
            font-size: calc(18px * var(--font-scale)); 
            font-weight: 600; 
        }
        
        .close-btn { 
            background: none; 
            border: none; 
            font-size: calc(24px * var(--font-scale)); 
            color: var(--text-secondary); 
            cursor: pointer; 
            padding: 0; 
            width: 32px; 
            height: 32px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal-body { 
            padding: 16px; 
        }
        
        .form-group { 
            margin-bottom: 15px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-size: calc(13px * var(--font-scale)); 
            color: var(--text-secondary); 
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: calc(14px * var(--font-scale)); 
            background: var(--card-bg); 
            color: var(--text-color); 
            transition: border-color 0.2s; 
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--accent-color); 
        }
        
        textarea { 
            resize: vertical; 
            min-height: 80px; 
        }
        
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            font-size: calc(14px * var(--font-scale)); 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--highlight-color) 100%); 
            color: white; 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-secondary { 
            background: var(--border-color); 
            color: var(--text-color); 
        }
        
        .form-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 40px 20px; 
            color: var(--text-secondary); 
        }
        
        .empty-icon { 
            font-size: calc(48px * var(--font-scale)); 
            margin-bottom: 10px; 
            opacity: 0.3; 
        }
        
        .empty-message { 
            font-size: calc(14px * var(--font-scale)); 
        }
        
        .toast { 
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 8px; 
            font-size: calc(13px * var(--font-scale)); 
            z-index: 2000; 
            animation: toastSlideUp 0.3s;
        }
        
        @keyframes toastSlideUp { 
            from { transform: translate(-50%, 100px); } 
            to { transform: translate(-50%, 0); } 
        }
        
        .color-options { 
            display: flex; 
            gap: 8px; 
            margin-top: 10px; 
        }
        
        .color-dot { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            border: 3px solid transparent; 
            transition: all 0.2s; 
        }
        
        .color-dot.selected { 
            border-color: var(--text-color); 
            transform: scale(1.2); 
        }
        
        .accessibility-group {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .group-title {
            font-size: calc(14px * var(--font-scale));
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .setting-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .option-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: calc(12px * var(--font-scale));
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .option-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        /* Theme selector */
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card-bg);
        }
        
        .theme-option:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .theme-option.active {
            border-color: var(--accent-color);
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0));
            box-shadow: 0 2px 10px var(--shadow-color);
        }
        
        .theme-preview {
            width: 50px;
            height: 35px;
            border-radius: 6px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .theme-preview-left {
            flex: 1;
            border-right: 1px solid rgba(255,255,255,0.3);
        }
        
        .theme-preview-right {
            flex: 1;
        }
        
        .theme-name {
            font-size: calc(10px * var(--font-scale));
            color: var(--text-color);
            text-align: center;
            font-weight: 500;
        }
        
        .theme-option.active .theme-name {
            font-weight: 700;
            color: var(--accent-color);
        }
        
        /* Sticky Note Styles */
        .sticky-note {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-2deg);
            background: linear-gradient(135deg, #fff9c4 0%, #ffeb3b 100%);
            padding: 20px;
            width: 280px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border-radius: 2px;
            z-index: 3000;
            animation: stickyPop 0.5s ease-out;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        
        @keyframes stickyPop {
            0% { 
                transform: translate(-50%, -50%) rotate(-2deg) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) rotate(-2deg) scale(1.1);
            }
            100% { 
                transform: translate(-50%, -50%) rotate(-2deg) scale(1);
                opacity: 1;
            }
        }
        
        .sticky-note::before {
            content: 'üìå';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
        }
        
        .sticky-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .sticky-content {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }
        
        .sticky-content ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .sticky-content li {
            margin: 3px 0;
        }
        
        .sticky-time {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 10px;
            color: #666;
            font-style: italic;
        }
        
        @keyframes stickyFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) rotate(-2deg) scale(0.8); }
        }
        
        .sticky-note.fade-out {
            animation: stickyFadeOut 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="fixed-header-section">
            <div class="header">
                <div class="header-content">
                    <div class="header-left" onclick="currentView = 'dashboard'; renderView()">
                        <div>
                            <h1>Builder Pro</h1>
                            <div class="header-subtitle">Complete Project Manager</div>
                        </div>
                    </div>
                    <div class="header-controls">
                        <button class="header-btn" onclick="syncData()">
                            üîÑ
                            <div class="sync-indicator" id="syncIndicator"></div>
                        </button>
                        <button class="header-btn" onclick="showSettings()">‚öôÔ∏è</button>
                    </div>
                </div>
            </div>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="projectCount">0</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="taskCount">0</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completionRate">0%</div>
                    <div class="stat-label">Complete</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalValue">$0</div>
                    <div class="stat-label">Value</div>
                </div>
            </div>
            
            <div class="quick-actions">
                <button class="quick-action-btn active" onclick="currentView = 'dashboard'; renderView()">üìä Dashboard</button>
                <button class="quick-action-btn" onclick="currentView = 'projects'; renderView()">üèóÔ∏è Projects</button>
                <button class="quick-action-btn" onclick="currentView = 'tasks'; renderView()">‚úÖ Tasks</button>
                <button class="quick-action-btn" onclick="currentView = 'finance'; renderView()">üí∞ Finance</button>
                <button class="quick-action-btn" onclick="showAddProject()">‚ûï Project</button>
                <button class="quick-action-btn" onclick="showAddTask()">üìù Task</button>
                <button class="quick-action-btn" onclick="showAddTransaction()">üíµ Transaction</button>
                <button class="quick-action-btn" onclick="currentView = 'trash'; renderView()">üóëÔ∏è Trash</button>
            </div>
        </div>
        
        <div class="main-content-wrapper">
            <div class="main-content" id="mainContent">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Modal</span>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic modal content -->
            </div>
        </div>
    </div>
    
    <script>
        // Data structure
        let data = {
            projects: [],
            tasks: [],
            transactions: [],
            trash: [],
            permanentlyDeleted: [],
            settings: {
                nightMode: false,
                contrast: 'normal',
                fontSize: 'm',
                saturation: 'normal',
                theme: 'rose'
            }
        };
        
        let currentView = 'dashboard';
        let editingItem = null;
        let syncApiKey = '';
        let reminderInterval = null;
        let lastReminderTime = Date.now();
        
        const APP_CONFIG = {
            binId: '6781c1cbad19ca34f8ea0b59',
            baseUrl: 'https://api.jsonbin.io/v3'
        };
        
        // Theme configurations
        const themes = {
            rose: { name: 'Rose', accent: '#d2bcbf', highlight: '#a67980' },
            sage: { name: 'Sage', accent: '#c0ccb8', highlight: '#60665c' },
            gold: { name: 'Gold', accent: '#e0b558', highlight: '#ecd299' },
            ocean: { name: 'Ocean', accent: '#99b3ec', highlight: '#151b73' },
            slate: { name: 'Slate', accent: '#8386a4', highlight: '#191a22' },
            teal: { name: 'Teal', accent: '#90b2b8', highlight: '#2c4144' },
            mint: { name: 'Mint', accent: '#9cbbbf', highlight: '#436266' }
        };
        
        // Initialize
        window.addEventListener('load', () => {
            loadData();
            applySettings();
            renderView();
            updateStats();
            
            // Start reminder system
            startReminderSystem();
            
            // Load API key
            syncApiKey = localStorage.getItem('builderProSyncApiKey') || '';
            
            // Auto-sync every 5 minutes
            setInterval(() => {
                if (syncApiKey && navigator.onLine) {
                    syncData();
                }
            }, 300000);
        });
        
        // Reminder System
        function startReminderSystem() {
            // Clear any existing interval
            if (reminderInterval) {
                clearInterval(reminderInterval);
            }
            
            // Set random interval between 35-45 minutes
            const minMinutes = 35;
            const maxMinutes = 45;
            const randomMinutes = Math.random() * (maxMinutes - minMinutes) + minMinutes;
            const intervalMs = randomMinutes * 60 * 1000;
            
            reminderInterval = setInterval(() => {
                showStickyNote();
            }, intervalMs);
        }
        
        function showStickyNote() {
            const reminders = generateReminders();
            
            if (reminders.length === 0) return;
            
            const stickyNote = document.createElement('div');
            stickyNote.className = 'sticky-note';
            
            const title = document.createElement('div');
            title.className = 'sticky-title';
            title.textContent = 'üîî Quick Check Reminder';
            
            const content = document.createElement('div');
            content.className = 'sticky-content';
            content.innerHTML = `
                <ul>
                    ${reminders.map(r => `<li>${r}</li>`).join('')}
                </ul>
            `;
            
            const time = document.createElement('div');
            time.className = 'sticky-time';
            time.textContent = new Date().toLocaleTimeString();
            
            stickyNote.appendChild(title);
            stickyNote.appendChild(content);
            stickyNote.appendChild(time);
            
            document.body.appendChild(stickyNote);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                stickyNote.classList.add('fade-out');
                setTimeout(() => {
                    stickyNote.remove();
                }, 500);
            }, 5000);
            
            // Restart the reminder system with a new random interval
            startReminderSystem();
        }
        
        function generateReminders() {
            const reminders = [];
            const now = new Date();
            const today = now.toDateString();
            
            // Check overdue tasks
            const overdueTasks = data.tasks.filter(t => 
                !t.completed && t.dueDate && new Date(t.dueDate) < now
            );
            if (overdueTasks.length > 0) {
                reminders.push(`üìÖ ${overdueTasks.length} overdue task${overdueTasks.length > 1 ? 's' : ''}`);
            }
            
            // Check tasks due today
            const todayTasks = data.tasks.filter(t => 
                !t.completed && t.dueDate && new Date(t.dueDate).toDateString() === today
            );
            if (todayTasks.length > 0) {
                reminders.push(`‚úÖ ${todayTasks.length} task${todayTasks.length > 1 ? 's' : ''} due today`);
            }
            
            // Check projects nearing deadline
            const nearDeadlineProjects = data.projects.filter(p => {
                if (!p.endDate || p.status === 'completed') return false;
                const daysUntilDeadline = Math.ceil((new Date(p.endDate) - now) / (1000 * 60 * 60 * 24));
                return daysUntilDeadline <= 3 && daysUntilDeadline >= 0;
            });
            if (nearDeadlineProjects.length > 0) {
                reminders.push(`‚ö†Ô∏è ${nearDeadlineProjects.length} project${nearDeadlineProjects.length > 1 ? 's' : ''} ending soon`);
            }
            
            // Check incomplete tasks count
            const incompleteTasks = data.tasks.filter(t => !t.completed).length;
            if (incompleteTasks > 10) {
                reminders.push(`üìù ${incompleteTasks} pending tasks to review`);
            }
            
            // Check financial summary
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthTransactions = data.transactions.filter(t => 
                new Date(t.date) >= monthStart
            );
            if (monthTransactions.length > 0) {
                const monthTotal = monthTransactions.reduce((sum, t) => 
                    sum + (t.type === 'income' ? t.amount : -t.amount), 0
                );
                reminders.push(`üí∞ Month balance: $${monthTotal.toFixed(2)}`);
            }
            
            // Random motivational message if no other reminders
            if (reminders.length === 0) {
                const motivations = [
                    'üåü Keep up the great work!',
                    'üí™ You\'re doing amazing!',
                    'üéØ Stay focused on your goals!',
                    'üöÄ Progress over perfection!',
                    '‚ú® Every step counts!'
                ];
                reminders.push(motivations[Math.floor(Math.random() * motivations.length)]);
            }
            
            return reminders;
        }
        
        // Apply theme
        function applyTheme(themeName) {
            // Remove all theme classes
            const themeClasses = ['theme-rose', 'theme-sage', 'theme-gold', 'theme-ocean', 'theme-slate', 'theme-teal', 'theme-mint'];
            themeClasses.forEach(cls => document.body.classList.remove(cls));
            
            // Add new theme class
            document.body.classList.add(`theme-${themeName}`);
            
            // Update theme color meta tag
            const theme = themes[themeName];
            if (theme) {
                document.querySelector('meta[name="theme-color"]').content = theme.accent;
                document.querySelector('meta[name="msapplication-navbutton-color"]').content = theme.accent;
            }
            
            // Save to settings
            data.settings.theme = themeName;
            saveData();
            
            // Force a repaint to ensure CSS variables update
            document.body.style.display = 'none';
            document.body.offsetHeight; // Trigger reflow
            document.body.style.display = '';
        }
        
        // Data management
        function loadData() {
            const saved = localStorage.getItem('builderProData');
            if (saved) {
                try {
                    data = JSON.parse(saved);
                    // Ensure settings exists with theme
                    if (!data.settings) {
                        data.settings = {
                            nightMode: false,
                            contrast: 'normal',
                            fontSize: 'm',
                            saturation: 'normal',
                            theme: 'rose'
                        };
                    }
                    if (!data.settings.theme) {
                        data.settings.theme = 'rose';
                    }
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }
        }
        
        function saveData() {
            localStorage.setItem('builderProData', JSON.stringify(data));
        }
        
        function applySettings() {
            // Remove all possible classes first
            document.body.classList.remove('night-mode');
            document.body.classList.remove('low-contrast', 'normal-contrast', 'high-contrast', 'extra-contrast');
            document.body.classList.remove('font-s', 'font-m', 'font-l', 'font-xl', 'font-xxl');
            document.body.classList.remove('sat-low', 'sat-normal', 'sat-high', 'sat-vibrant');
            document.body.classList.remove('theme-rose', 'theme-sage', 'theme-gold', 'theme-ocean', 'theme-slate', 'theme-teal', 'theme-mint');
            
            // Apply night mode if enabled
            if (data.settings.nightMode) {
                document.body.classList.add('night-mode');
            }
            
            // Apply contrast setting
            document.body.classList.add(`${data.settings.contrast}-contrast`);
            
            // Apply font size
            document.body.classList.add(`font-${data.settings.fontSize}`);
            
            // Apply saturation
            document.body.classList.add(`sat-${data.settings.saturation}`);
            
            // Apply theme - ensure a default if not set
            const themeName = data.settings.theme || 'rose';
            document.body.classList.add(`theme-${themeName}`);
            
            // Update theme meta tags
            const theme = themes[themeName];
            if (theme) {
                const themeMetaTag = document.querySelector('meta[name="theme-color"]');
                const msMetaTag = document.querySelector('meta[name="msapplication-navbutton-color"]');
                if (themeMetaTag) themeMetaTag.content = theme.accent;
                if (msMetaTag) msMetaTag.content = theme.accent;
            }
        }
        
        // Render functions
        function renderView() {
            const content = document.getElementById('mainContent');
            
            // Update active button
            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const viewMap = {
                'dashboard': 0,
                'projects': 1,
                'tasks': 2,
                'finance': 3
            };
            
            if (viewMap[currentView] !== undefined) {
                document.querySelectorAll('.quick-action-btn')[viewMap[currentView]].classList.add('active');
            }
            
            switch(currentView) {
                case 'dashboard':
                    renderDashboard(content);
                    break;
                case 'projects':
                    renderProjects(content);
                    break;
                case 'tasks':
                    renderTasks(content);
                    break;
                case 'finance':
                    renderFinance(content);
                    break;
                case 'trash':
                    renderTrash(content);
                    break;
            }
        }
        
        function renderDashboard(content) {
            const recentProjects = data.projects.slice(-3).reverse();
            const recentTasks = data.tasks.filter(t => !t.completed).slice(-3).reverse();
            
            content.innerHTML = `
                <h2 style="margin-bottom: 15px; font-size: calc(18px * var(--font-scale));">Dashboard</h2>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: calc(14px * var(--font-scale)); color: var(--text-secondary); margin-bottom: 10px;">Recent Projects</h3>
                    ${recentProjects.map(p => renderProjectCard(p)).join('') || '<div class="empty-state"><div class="empty-icon">üèóÔ∏è</div><div class="empty-message">No projects yet</div></div>'}
                </div>
                
                <div>
                    <h3 style="font-size: calc(14px * var(--font-scale)); color: var(--text-secondary); margin-bottom: 10px;">Pending Tasks</h3>
                    ${recentTasks.map(t => renderTaskItem(t)).join('') || '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-message">No pending tasks</div></div>'}
                </div>
            `;
        }
        
        function renderProjects(content) {
            const projects = data.projects.filter(p => p.status !== 'deleted');
            content.innerHTML = `
                <h2 style="margin-bottom: 15px; font-size: calc(18px * var(--font-scale));">Projects</h2>
                ${projects.map(p => renderProjectCard(p)).join('') || '<div class="empty-state"><div class="empty-icon">üèóÔ∏è</div><div class="empty-message">No projects yet. Click "+ Project" to add one.</div></div>'}
            `;
        }
        
        function renderTasks(content) {
            const tasks = data.tasks.filter(t => t.status !== 'deleted');
            const pending = tasks.filter(t => !t.completed);
            const completed = tasks.filter(t => t.completed);
            
            content.innerHTML = `
                <h2 style="margin-bottom: 15px; font-size: calc(18px * var(--font-scale));">Tasks</h2>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: calc(14px * var(--font-scale)); color: var(--text-secondary); margin-bottom: 10px;">Pending (${pending.length})</h3>
                    ${pending.map(t => renderTaskItem(t)).join('') || '<div class="empty-state"><div class="empty-icon">üìù</div><div class="empty-message">No pending tasks</div></div>'}
                </div>
                
                <div>
                    <h3 style="font-size: calc(14px * var(--font-scale)); color: var(--text-secondary); margin-bottom: 10px;">Completed (${completed.length})</h3>
                    ${completed.map(t => renderTaskItem(t)).join('') || '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-message">No completed tasks</div></div>'}
                </div>
            `;
        }
        
        function renderFinance(content) {
            const transactions = data.transactions.filter(t => t.status !== 'deleted');
            const income = transactions.filter(t => t.type === 'income');
            const expenses = transactions.filter(t => t.type === 'expense');
            const totalIncome = income.reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpenses;
            
            content.innerHTML = `
                <h2 style="margin-bottom: 15px; font-size: calc(18px * var(--font-scale));">Finance</h2>
                
                <div style="background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px var(--shadow-color);">
                    <div style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <div style="color: var(--income-color); font-size: calc(20px * var(--font-scale)); font-weight: bold;">$${totalIncome.toFixed(2)}</div>
                            <div style="font-size: calc(11px * var(--font-scale)); color: var(--text-secondary);">Income</div>
                        </div>
                        <div>
                            <div style="color: var(--expense-color); font-size: calc(20px * var(--font-scale)); font-weight: bold;">$${totalExpenses.toFixed(2)}</div>
                            <div style="font-size: calc(11px * var(--font-scale)); color: var(--text-secondary);">Expenses</div>
                        </div>
                        <div>
                            <div style="color: ${balance >= 0 ? 'var(--income-color)' : 'var(--expense-color)'}; font-size: calc(20px * var(--font-scale)); font-weight: bold;">$${balance.toFixed(2)}</div>
                            <div style="font-size: calc(11px * var(--font-scale)); color: var(--text-secondary);">Balance</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="font-size: calc(14px * var(--font-scale)); color: var(--text-secondary); margin-bottom: 10px;">Transactions</h3>
                ${transactions.map(t => renderTransactionItem(t)).join('') || '<div class="empty-state"><div class="empty-icon">üí∞</div><div class="empty-message">No transactions yet</div></div>'}
            `;
        }
        
        function renderTrash(content) {
            const trashedItems = data.trash || [];
            
            content.innerHTML = `
                <h2 style="margin-bottom: 15px; font-size: calc(18px * var(--font-scale));">Trash</h2>
                
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-danger" onclick="emptyTrash()" style="margin-right: 10px;">Empty Trash</button>
                    <button class="btn btn-secondary" onclick="restoreAll()">Restore All</button>
                </div>
                
                ${trashedItems.map(item => `
                    <div class="project-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${item.type}: ${item.data.title || item.data.description || 'Unnamed'}</div>
                                <div style="font-size: calc(11px * var(--font-scale)); color: var(--text-secondary);">Deleted: ${new Date(item.deletedAt).toLocaleDateString()}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="restoreItem('${item.id}')">Restore</button>
                                <button class="btn btn-danger" onclick="permanentDelete('${item.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('') || '<div class="empty-state"><div class="empty-icon">üóëÔ∏è</div><div class="empty-message">Trash is empty</div></div>'}
            `;
        }
        
        function renderProjectCard(project) {
            const tasks = data.tasks.filter(t => t.projectId === project.id && t.status !== 'deleted');
            const completedTasks = tasks.filter(t => t.completed).length;
            const totalTasks = tasks.length;
            const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            
            const transactions = data.transactions.filter(t => t.projectId === project.id && t.status !== 'deleted');
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netValue = income - expenses;
            
            return `
                <div class="project-card" onclick="editProject('${project.id}')">
                    <div class="project-header">
                        <div class="project-title">${project.title}</div>
                        <div class="project-value" style="color: ${netValue >= 0 ? 'var(--income-color)' : 'var(--expense-color)'}">$${netValue.toFixed(2)}</div>
                    </div>
                    <div class="project-dates">
                        ${project.startDate || 'No start'} - ${project.endDate || 'No end'}
                    </div>
                    <div class="project-progress">
                        <div class="progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="project-stats">
                        <div class="stat-group">
                            <span>üìù ${totalTasks} tasks</span>
                            <span>‚úÖ ${completedTasks} done</span>
                        </div>
                        <div>
                            <span style="color: var(--text-secondary); font-size: calc(10px * var(--font-scale));">${project.status || 'active'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderTaskItem(task) {
            const project = data.projects.find(p => p.id === task.projectId);
            return `
                <div class="task-item" onclick="editTask('${task.id}')">
                    <div class="task-left">
                        <div class="task-title">${task.title}</div>
                        <div class="task-project">${project ? project.title : 'No project'} ${task.dueDate ? `‚Ä¢ Due: ${new Date(task.dueDate).toLocaleDateString()}` : ''}</div>
                    </div>
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="event.stopPropagation(); toggleTask('${task.id}')"></div>
                </div>
            `;
        }
        
        function renderTransactionItem(transaction) {
            const project = data.projects.find(p => p.id === transaction.projectId);
            return `
                <div class="transaction-item" onclick="editTransaction('${transaction.id}')">
                    <div class="transaction-header">
                        <div class="transaction-title">${transaction.description}</div>
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}$${transaction.amount.toFixed(2)}
                        </div>
                    </div>
                    <div class="transaction-details">
                        <span>${project ? project.title : 'No project'}</span>
                        <span>${new Date(transaction.date).toLocaleDateString()}</span>
                    </div>
                </div>
            `;
        }
        
        // Update stats
        function updateStats() {
            const projects = data.projects.filter(p => p.status !== 'deleted');
            const tasks = data.tasks.filter(t => t.status !== 'deleted');
            const completedTasks = tasks.filter(t => t.completed).length;
            const completionRate = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
            
            const transactions = data.transactions.filter(t => t.status !== 'deleted');
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalValue = income - expenses;
            
            document.getElementById('projectCount').textContent = projects.length;
            document.getElementById('taskCount').textContent = tasks.length;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('totalValue').textContent = '$' + totalValue.toFixed(0);
        }
        
        // Modal functions
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            editingItem = null;
        }
        
        // CRUD Operations
        function showAddProject() {
            editingItem = null;
            showModal('Add Project', `
                <form onsubmit="event.preventDefault(); saveProject()">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="projectTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="projectDescription"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="projectStartDate">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="projectEndDate">
                    </div>
                    <div class="form-group">
                        <label>Budget</label>
                        <input type="number" id="projectBudget" step="0.01">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }
        
        function editProject(id) {
            const project = data.projects.find(p => p.id === id);
            if (!project) return;
            
            editingItem = project;
            showModal('Edit Project', `
                <form onsubmit="event.preventDefault(); saveProject()">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="projectTitle" value="${project.title}" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="projectDescription">${project.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="projectStartDate" value="${project.startDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="projectEndDate" value="${project.endDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>Budget</label>
                        <input type="number" id="projectBudget" step="0.01" value="${project.budget || ''}">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="projectStatus">
                            <option value="active" ${project.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="on-hold" ${project.status === 'on-hold' ? 'selected' : ''}>On Hold</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-danger" onclick="deleteProject('${project.id}')">Delete</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }
        
        function saveProject() {
            const project = {
                id: editingItem ? editingItem.id : Date.now().toString(),
                title: document.getElementById('projectTitle').value,
                description: document.getElementById('projectDescription').value,
                startDate: document.getElementById('projectStartDate').value,
                endDate: document.getElementById('projectEndDate').value,
                budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                status: document.getElementById('projectStatus') ? document.getElementById('projectStatus').value : 'active',
                createdAt: editingItem ? editingItem.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingItem) {
                const index = data.projects.findIndex(p => p.id === editingItem.id);
                data.projects[index] = project;
            } else {
                data.projects.push(project);
            }
            
            saveData();
            closeModal();
            renderView();
            updateStats();
            showToast(editingItem ? 'Project updated' : 'Project added');
        }
        
        function deleteProject(id) {
            if (confirm('Delete this project? It will be moved to trash.')) {
                const project = data.projects.find(p => p.id === id);
                if (project) {
                    // Move to trash
                    if (!data.trash) data.trash = [];
                    data.trash.push({
                        id: Date.now().toString(),
                        type: 'project',
                        data: project,
                        deletedAt: new Date().toISOString()
                    });
                    
                    // Mark as deleted
                    project.status = 'deleted';
                    
                    saveData();
                    closeModal();
                    renderView();
                    updateStats();
                    showToast('Project moved to trash');
                }
            }
        }
        
        function showAddTask() {
            editingItem = null;
            const projectOptions = data.projects.filter(p => p.status !== 'deleted')
                .map(p => `<option value="${p.id}">${p.title}</option>`)
                .join('');
            
            showModal('Add Task', `
                <form onsubmit="event.preventDefault(); saveTask()">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="taskTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Project</label>
                        <select id="taskProject">
                            <option value="">No project</option>
                            ${projectOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="taskDueDate">
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }
        
        function editTask(id) {
            const task = data.tasks.find(t => t.id === id);
            if (!task) return;
            
            editingItem = task;
            const projectOptions = data.projects.filter(p => p.status !== 'deleted')
                .map(p => `<option value="${p.id}" ${task.projectId === p.id ? 'selected' : ''}>${p.title}</option>`)
                .join('');
            
            showModal('Edit Task', `
                <form onsubmit="event.preventDefault(); saveTask()">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="taskTitle" value="${task.title}" required>
                    </div>
                    <div class="form-group">
                        <label>Project</label>
                        <select id="taskProject">
                            <option value="">No project</option>
                            ${projectOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="taskDueDate" value="${task.dueDate || ''}">
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="taskPriority">
                            <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="taskCompleted" ${task.completed ? 'checked' : ''}>
                            Completed
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-danger" onclick="deleteTask('${task.id}')">Delete</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }
        
        function saveTask() {
            const task = {
                id: editingItem ? editingItem.id : Date.now().toString(),
                title: document.getElementById('taskTitle').value,
                projectId: document.getElementById('taskProject').value,
                dueDate: document.getElementById('taskDueDate').value,
                priority: document.getElementById('taskPriority').value,
                completed: document.getElementById('taskCompleted') ? document.getElementById('taskCompleted').checked : false,
                createdAt: editingItem ? editingItem.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingItem) {
                const index = data.tasks.findIndex(t => t.id === editingItem.id);
                data.tasks[index] = task;
            } else {
                data.tasks.push(task);
            }
            
            saveData();
            closeModal();
            renderView();
            updateStats();
            showToast(editingItem ? 'Task updated' : 'Task added');
        }
        
        function toggleTask(id) {
            const task = data.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                task.updatedAt = new Date().toISOString();
                saveData();
                renderView();
                updateStats();
            }
        }
        
        function deleteTask(id) {
            if (confirm('Delete this task? It will be moved to trash.')) {
                const task = data.tasks.find(t => t.id === id);
                if (task) {
                    // Move to trash
                    if (!data.trash) data.trash = [];
                    data.trash.push({
                        id: Date.now().toString(),
                        type: 'task',
                        data: task,
                        deletedAt: new Date().toISOString()
                    });
                    
                    // Mark as deleted
                    task.status = 'deleted';
                    
                    saveData();
                    closeModal();
                    renderView();
                    updateStats();
                    showToast('Task moved to trash');
                }
            }
        }
        
        function showAddTransaction() {
            editingItem = null;
            const projectOptions = data.projects.filter(p => p.status !== 'deleted')
                .map(p => `<option value="${p.id}">${p.title}</option>`)
                .join('');
            
            showModal('Add Transaction', `
                <form onsubmit="event.preventDefault(); saveTransaction()">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="transactionType">
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="transactionAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="transactionDescription" required>
                    </div>
                    <div class="form-group">
                        <label>Project</label>
                        <select id="transactionProject">
                            <option value="">No project</option>
                            ${projectOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="transactionDate" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }
        
        function editTransaction(id) {
            const transaction = data.transactions.find(t => t.id === id);
            if (!transaction) return;
            
            editingItem = transaction;
            const projectOptions = data.projects.filter(p => p.status !== 'deleted')
                .map(p => `<option value="${p.id}" ${transaction.projectId === p.id ? 'selected' : ''}>${p.title}</option>`)
                .join('');
            
            showModal('Edit Transaction', `
                <form onsubmit="event.preventDefault(); saveTransaction()">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="transactionType">
                            <option value="income" ${transaction.type === 'income' ? 'selected' : ''}>Income</option>
                            <option value="expense" ${transaction.type === 'expense' ? 'selected' : ''}>Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="transactionAmount" step="0.01" value="${transaction.amount}" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="transactionDescription" value="${transaction.description}" required>
                    </div>
                    <div class="form-group">
                        <label>Project</label>
                        <select id="transactionProject">
                            <option value="">No project</option>
                            ${projectOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="transactionDate" value="${transaction.date}" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-danger" onclick="deleteTransaction('${transaction.id}')">Delete</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }
        
        function saveTransaction() {
            const transaction = {
                id: editingItem ? editingItem.id : Date.now().toString(),
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                description: document.getElementById('transactionDescription').value,
                projectId: document.getElementById('transactionProject').value,
                date: document.getElementById('transactionDate').value,
                createdAt: editingItem ? editingItem.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingItem) {
                const index = data.transactions.findIndex(t => t.id === editingItem.id);
                data.transactions[index] = transaction;
            } else {
                data.transactions.push(transaction);
            }
            
            saveData();
            closeModal();
            renderView();
            updateStats();
            showToast(editingItem ? 'Transaction updated' : 'Transaction added');
        }
        
        function deleteTransaction(id) {
            if (confirm('Delete this transaction? It will be moved to trash.')) {
                const transaction = data.transactions.find(t => t.id === id);
                if (transaction) {
                    // Move to trash
                    if (!data.trash) data.trash = [];
                    data.trash.push({
                        id: Date.now().toString(),
                        type: 'transaction',
                        data: transaction,
                        deletedAt: new Date().toISOString()
                    });
                    
                    // Mark as deleted
                    transaction.status = 'deleted';
                    
                    saveData();
                    closeModal();
                    renderView();
                    updateStats();
                    showToast('Transaction moved to trash');
                }
            }
        }
        
        // Trash functions
        function restoreItem(id) {
            const itemIndex = data.trash.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                const item = data.trash[itemIndex];
                
                // Restore the item
                item.data.status = 'active';
                delete item.data.deletedAt;
                
                // Remove from trash
                data.trash.splice(itemIndex, 1);
                
                saveData();
                renderView();
                updateStats();
                showToast('Item restored');
            }
        }
        
        function restoreAll() {
            if (data.trash && data.trash.length > 0) {
                if (confirm(`Restore all ${data.trash.length} items from trash?`)) {
                    data.trash.forEach(item => {
                        item.data.status = 'active';
                        delete item.data.deletedAt;
                    });
                    
                    data.trash = [];
                    saveData();
                    renderView();
                    updateStats();
                    showToast('All items restored');
                }
            }
        }
        
        function permanentDelete(id) {
            if (confirm('Permanently delete this item? This cannot be undone!')) {
                const itemIndex = data.trash.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    const item = data.trash[itemIndex];
                    
                    // Track permanently deleted items
                    if (!data.permanentlyDeleted) data.permanentlyDeleted = [];
                    data.permanentlyDeleted.push({
                        ...item,
                        permanentlyDeletedAt: new Date().toISOString()
                    });
                    
                    // Remove from the appropriate array
                    if (item.type === 'project') {
                        const index = data.projects.findIndex(p => p.id === item.data.id);
                        if (index !== -1) data.projects.splice(index, 1);
                    } else if (item.type === 'task') {
                        const index = data.tasks.findIndex(t => t.id === item.data.id);
                        if (index !== -1) data.tasks.splice(index, 1);
                    } else if (item.type === 'transaction') {
                        const index = data.transactions.findIndex(t => t.id === item.data.id);
                        if (index !== -1) data.transactions.splice(index, 1);
                    }
                    
                    // Remove from trash
                    data.trash.splice(itemIndex, 1);
                    
                    saveData();
                    renderView();
                    updateStats();
                    showToast('Item permanently deleted');
                }
            }
        }
        
        function emptyTrash() {
            if (data.trash && data.trash.length > 0) {
                if (confirm(`Permanently delete all ${data.trash.length} items? This cannot be undone!`)) {
                    // Track permanently deleted items
                    if (!data.permanentlyDeleted) data.permanentlyDeleted = [];
                    
                    data.trash.forEach(item => {
                        data.permanentlyDeleted.push({
                            ...item,
                            permanentlyDeletedAt: new Date().toISOString()
                        });
                        
                        // Remove from the appropriate array
                        if (item.type === 'project') {
                            const index = data.projects.findIndex(p => p.id === item.data.id);
                            if (index !== -1) data.projects.splice(index, 1);
                        } else if (item.type === 'task') {
                            const index = data.tasks.findIndex(t => t.id === item.data.id);
                            if (index !== -1) data.tasks.splice(index, 1);
                        } else if (item.type === 'transaction') {
                            const index = data.transactions.findIndex(t => t.id === item.data.id);
                            if (index !== -1) data.transactions.splice(index, 1);
                        }
                    });
                    
                    data.trash = [];
                    saveData();
                    renderView();
                    updateStats();
                    showToast('Trash emptied');
                }
            }
        }
        
        // Settings
        function showSettings() {
            const lastSync = localStorage.getItem('lastSyncTime');
            const lastSyncDisplay = lastSync ? new Date(parseInt(lastSync)).toLocaleString() : 'Never';
            
            showModal('Settings', `
                <div class="accessibility-group">
                    <div class="group-title">üé® Theme Color</div>
                    <div class="theme-selector">
                        ${Object.entries(themes).map(([key, theme]) => `
                            <div class="theme-option ${data.settings.theme === key ? 'active' : ''}" onclick="selectTheme('${key}')" style="cursor: pointer;">
                                <div class="theme-preview" style="border: 2px solid ${data.settings.theme === key ? theme.accent : '#ddd'}; border-radius: 6px;">
                                    <div class="theme-preview-left" style="background: ${theme.accent}"></div>
                                    <div class="theme-preview-right" style="background: ${theme.highlight}"></div>
                                </div>
                                <div class="theme-name" style="font-weight: ${data.settings.theme === key ? 'bold' : 'normal'};">${theme.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="accessibility-group">
                    <div class="group-title">Display Mode</div>
                    <div class="setting-options">
                        <button class="option-btn ${!data.settings.nightMode ? 'active' : ''}" onclick="toggleNightMode(false)">‚òÄÔ∏è Light</button>
                        <button class="option-btn ${data.settings.nightMode ? 'active' : ''}" onclick="toggleNightMode(true)">üåô Dark</button>
                    </div>
                </div>
                
                <div class="accessibility-group">
                    <div class="group-title">Text Size</div>
                    <div class="setting-options">
                        <button class="option-btn ${data.settings.fontSize === 's' ? 'active' : ''}" onclick="setFontSize('s')">Small</button>
                        <button class="option-btn ${data.settings.fontSize === 'm' ? 'active' : ''}" onclick="setFontSize('m')">Medium</button>
                        <button class="option-btn ${data.settings.fontSize === 'l' ? 'active' : ''}" onclick="setFontSize('l')">Large</button>
                        <button class="option-btn ${data.settings.fontSize === 'xl' ? 'active' : ''}" onclick="setFontSize('xl')">X-Large</button>
                        <button class="option-btn ${data.settings.fontSize === 'xxl' ? 'active' : ''}" onclick="setFontSize('xxl')">XX-Large</button>
                    </div>
                </div>
                
                <div class="accessibility-group">
                    <div class="group-title">Contrast</div>
                    <div class="setting-options">
                        <button class="option-btn ${data.settings.contrast === 'low' ? 'active' : ''}" onclick="setContrast('low')">Low</button>
                        <button class="option-btn ${data.settings.contrast === 'normal' ? 'active' : ''}" onclick="setContrast('normal')">Normal</button>
                        <button class="option-btn ${data.settings.contrast === 'high' ? 'active' : ''}" onclick="setContrast('high')">High</button>
                        <button class="option-btn ${data.settings.contrast === 'extra' ? 'active' : ''}" onclick="setContrast('extra')">Extra</button>
                    </div>
                </div>
                
                <div class="accessibility-group">
                    <div class="group-title">Color Saturation</div>
                    <div class="setting-options">
                        <button class="option-btn ${data.settings.saturation === 'low' ? 'active' : ''}" onclick="setSaturation('low')">Low</button>
                        <button class="option-btn ${data.settings.saturation === 'normal' ? 'active' : ''}" onclick="setSaturation('normal')">Normal</button>
                        <button class="option-btn ${data.settings.saturation === 'high' ? 'active' : ''}" onclick="setSaturation('high')">High</button>
                        <button class="option-btn ${data.settings.saturation === 'vibrant' ? 'active' : ''}" onclick="setSaturation('vibrant')">Vibrant</button>
                    </div>
                </div>
                
                <div class="accessibility-group">
                    <div class="group-title">Cloud Sync (JSONBin.io)</div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px;">API Key</label>
                        <input type="password" id="apiKeyInput" placeholder="Enter your JSONBin API key" style="width: 100%;">
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
                        <button class="btn btn-secondary" onclick="testSync()">Test Connection</button>
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 5px;">
                        Status: <span id="syncMode" style="font-weight: bold;">${syncApiKey ? 'Ready' : 'No API Key'}</span>
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary);" id="lastSyncTime">
                        Last: ${lastSyncDisplay}
                    </div>
                </div>
                
                <div class="accessibility-group">
                    <div class="group-title">Data Management</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="exportData()">üì• Export</button>
                        <label class="btn btn-secondary" style="margin: 0;">
                            üì§ Import
                            <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                        </label>
                    </div>
                </div>
            `);
        }
        
        function selectTheme(themeName) {
            applyTheme(themeName);
            showSettings(); // Refresh the modal to show the updated selection
            showToast(`Theme changed to ${themes[themeName].name}`);
        }
        
        function toggleNightMode(enabled) {
            data.settings.nightMode = enabled;
            applySettings();
            saveData();
            showSettings(); // Refresh modal
        }
        
        function setFontSize(size) {
            data.settings.fontSize = size;
            applySettings();
            saveData();
            showSettings(); // Refresh modal
        }
        
        function setContrast(level) {
            data.settings.contrast = level;
            applySettings();
            saveData();
            showSettings(); // Refresh modal
        }
        
        function setSaturation(level) {
            data.settings.saturation = level;
            applySettings();
            saveData();
            showSettings(); // Refresh modal
        }
        
        // Toast notification
        function showToast(message, duration = 3000) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), duration);
        }
        
        // Sync functions
        async function syncData() {
            if (!syncApiKey) {
                showToast('‚ö†Ô∏è No API key set! Go to Settings to add one.');
                return;
            }
            
            const indicator = document.getElementById('syncIndicator');
            const syncMode = document.getElementById('syncMode');
            
            const startTime = Date.now();
            indicator.classList.add('syncing');
            
            try {
                console.log('üîÑ Starting 3-way sync...');
                
                // STEP 1: FETCH from cloud
                console.log('üîÑ Step 1: Fetching from cloud...');
                syncMode.textContent = 'Fetching...';
                const response = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: {
                        'X-Master-Key': syncApiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Fetch failed: ${response.status} - ${response.statusText}`);
                }
                
                const result = await response.json();
                const cloudData = result.record;
                console.log('‚òÅÔ∏è Cloud data:', {
                    projects: cloudData.projects?.length || 0,
                    tasks: cloudData.tasks?.length || 0,
                    transactions: cloudData.transactions?.length || 0
                });
                
                // STEP 2: MERGE local and cloud data
                console.log('üîÑ Step 2: Merging data...');
                syncMode.textContent = 'Merging...';
                
                const beforeCounts = {
                    projects: data.projects.length,
                    tasks: data.tasks.length,
                    transactions: data.transactions.length
                };
                
                // Merge arrays (union by ID, prefer newer updatedAt)
                if (cloudData) {
                    // Merge projects
                    if (cloudData.projects) {
                        const projectMap = new Map();
                        [...data.projects, ...cloudData.projects].forEach(p => {
                            const existing = projectMap.get(p.id);
                            if (!existing || new Date(p.updatedAt) > new Date(existing.updatedAt)) {
                                projectMap.set(p.id, p);
                            }
                        });
                        data.projects = Array.from(projectMap.values());
                    }
                    
                    // Merge tasks
                    if (cloudData.tasks) {
                        const taskMap = new Map();
                        [...data.tasks, ...cloudData.tasks].forEach(t => {
                            const existing = taskMap.get(t.id);
                            if (!existing || new Date(t.updatedAt) > new Date(existing.updatedAt)) {
                                taskMap.set(t.id, t);
                            }
                        });
                        data.tasks = Array.from(taskMap.values());
                    }
                    
                    // Merge transactions
                    if (cloudData.transactions) {
                        const transMap = new Map();
                        [...data.transactions, ...cloudData.transactions].forEach(t => {
                            const existing = transMap.get(t.id);
                            if (!existing || new Date(t.updatedAt) > new Date(existing.updatedAt)) {
                                transMap.set(t.id, t);
                            }
                        });
                        data.transactions = Array.from(transMap.values());
                    }
                    
                    // Merge trash
                    if (cloudData.trash) {
                        data.trash = [
                            ...(data.trash || []),
                            ...cloudData.trash
                        ];
                        data.trash = Array.from(
                            new Map(data.trash.map(item => [item.id, item])).values()
                        );
                    }
                    
                    // Merge permanently deleted
                    if (cloudData.permanentlyDeleted) {
                        data.permanentlyDeleted = [
                            ...(data.permanentlyDeleted || []),
                            ...cloudData.permanentlyDeleted
                        ];
                        data.permanentlyDeleted = Array.from(
                            new Map(data.permanentlyDeleted.map(item => [item.id, item])).values()
                        );
                    }
                    
                    const afterCounts = {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    };
                    
                    // Show what changed during merge
                    const changes = [];
                    if (afterCounts.projects !== beforeCounts.projects) {
                        changes.push(`${afterCounts.projects - beforeCounts.projects > 0 ? '+' : ''}${afterCounts.projects - beforeCounts.projects} projects`);
                    }
                    if (afterCounts.tasks !== beforeCounts.tasks) {
                        changes.push(`${afterCounts.tasks - beforeCounts.tasks > 0 ? '+' : ''}${afterCounts.tasks - beforeCounts.tasks} tasks`);
                    }
                    if (afterCounts.transactions !== beforeCounts.transactions) {
                        changes.push(`${afterCounts.transactions - beforeCounts.transactions > 0 ? '+' : ''}${afterCounts.transactions - beforeCounts.transactions} trans`);
                    }
                    
                    console.log('‚úÖ Merge complete:', changes.length > 0 ? changes.join(', ') : 'No changes');
                    
                    saveData();
                    renderView();
                    updateStats();
                }
                
                // STEP 3: PUSH merged data back to cloud
                console.log('üîÑ Step 3: Pushing merged data to cloud...');
                syncMode.textContent = 'Pushing...';
                const putResponse = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': syncApiKey
                    },
                    body: JSON.stringify(data)
                });
                
                if (!putResponse.ok) {
                    throw new Error(`Push failed: ${putResponse.status} - ${putResponse.statusText}`);
                }
                
                const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Sync complete in ${syncDuration}s`);
                
                localStorage.setItem('lastSyncTime', Date.now().toString());
                const nowTime = new Date().toLocaleTimeString();
                document.getElementById('lastSyncTime').textContent = `Last: ${nowTime}`;
                showToast(`‚úÖ Synced ${data.projects.length}p ${data.tasks.length}t ${data.transactions.length}tr in ${syncDuration}s!`, 5000);
                indicator.classList.remove('syncing');
                syncMode.textContent = 'Connected';
                
            } catch (error) {
                const syncDuration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.error('‚ùå Sync error:', error);
                
                let errorMsg = error.message;
                if (error.message.includes('401')) {
                    errorMsg = 'Invalid API key! Check Settings';
                } else if (error.message.includes('404')) {
                    errorMsg = 'Bin not found! Check Bin ID';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'No internet connection!';
                }
                
                showToast(`‚ùå ${errorMsg}`, 6000);
                indicator.classList.remove('syncing');
                syncMode.textContent = 'Error';
                
                // Show detailed error in console
                console.log('Sync diagnostics:', {
                    duration: syncDuration + 's',
                    apiKey: syncApiKey ? 'SET (length: ' + syncApiKey.length + ')' : 'NOT SET',
                    binId: APP_CONFIG.binId,
                    online: navigator.onLine,
                    localData: {
                        projects: data.projects.length,
                        tasks: data.tasks.length,
                        transactions: data.transactions.length
                    }
                });
            }
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showToast('Please enter an API key');
                return;
            }
            
            syncApiKey = key;
            localStorage.setItem('builderProSyncApiKey', key);
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('syncMode').textContent = 'Ready';
            showToast('‚úÖ API key saved! Now click "Test Sync Connection"', 5000);
        }

        async function testSync() {
            if (!syncApiKey) {
                showToast('‚ö†Ô∏è No API key set! Enter your JSONBin API key first.');
                return;
            }
            
            showToast('üîç Testing connection...');
            
            try {
                console.log('üîç Testing sync connection...');
                console.log('API Key length:', syncApiKey.length);
                console.log('Bin ID:', APP_CONFIG.binId);
                console.log('Base URL:', APP_CONFIG.baseUrl);
                
                const response = await fetch(`${APP_CONFIG.baseUrl}/b/${APP_CONFIG.binId}/latest`, {
                    headers: {
                        'X-Master-Key': syncApiKey
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Connection successful!');
                    console.log('Cloud data:', {
                        projects: result.record?.projects?.length || 0,
                        tasks: result.record?.tasks?.length || 0,
                        transactions: result.record?.transactions?.length || 0
                    });
                    
                    showToast('‚úÖ Connection works! Your API key is valid.');
                    document.getElementById('syncMode').textContent = 'Connected';
                } else if (response.status === 401) {
                    showToast('‚ùå Invalid API key! Get a new one from jsonbin.io');
                    document.getElementById('syncMode').textContent = 'Invalid Key';
                } else if (response.status === 404) {
                    showToast('‚ùå Bin not found! Check your Bin ID.');
                    document.getElementById('syncMode').textContent = 'Invalid Bin';
                } else {
                    showToast(`‚ùå Error ${response.status}: ${response.statusText}`);
                    document.getElementById('syncMode').textContent = 'Error';
                }
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                showToast('‚ùå Connection failed! Check internet & open browser console (F12)');
                document.getElementById('syncMode').textContent = 'Offline';
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'builder-pro-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm('Replace all current data?')) {
                            data = imported;
                            saveData();
                            applySettings();
                            renderView();
                            updateStats();
                            showToast('Data imported');
                        }
                    } catch (error) {
                        showToast('Import failed');
                    }
                };
                reader.readAsText(file);
            }
        }
    </script>
</body>
</html>
