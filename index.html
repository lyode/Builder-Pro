<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Builder Pro">
    <meta name="apple-mobile-web-app-title" content="Builder Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#E8A9B3">
    <meta name="msapplication-navbutton-color" content="#E8A9B3">
    <meta name="msapplication-starturl" content="/">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" id="icon180">
    <link rel="apple-touch-icon" sizes="152x152" id="icon152">
    <link rel="apple-touch-icon" sizes="120x120" id="icon120">
    <link rel="icon" type="image/png" id="favicon">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQnVpbGRlciBQcm8gdjMiLCJzaG9ydF9uYW1lIjoiQnVpbGRlciBQcm8iLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI0U4QTlCMyIsInRoZW1lX2NvbG9yIjoiI0U4QTlCMyJ9">
    
    <title>Builder Pro</title>
    
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            
            --bg-color: #F4EDEB;
            --accent-color: #E8A9B3;
            --highlight-color: #D47C90;
            --text-color: #1C1C1C;
            
            --card-bg: #ffffff;
            --text-secondary: #5a5a5a;
            --border-color: #e8e8e8;
            --shadow-color: rgba(75, 43, 26, 0.08);
            --success: #10b981;
            --warning: #f39c12;
            --danger: #ef4444;
            --income-color: #10b981;
            --expense-color: #ef4444;
            
            --button-primary: #4B2B1A;
            --button-primary-hover: #6B4332;
            
            --contrast: 1;
            --brightness: 1;
            --font-scale: 1;
            
            /* Dark pink for timeline bars */
            --timeline-bar-color: #C91A6A;
        }

        /* Night Mode */
        body.night-mode {
            --bg-color: #1a1a1a;
            --accent-color: #4a4a4a;
            --highlight-color: #C91A6A;
            --text-color: #e0e0e0;
            --card-bg: #2a2a2a;
            --text-secondary: #a0a0a0;
            --border-color: #3a3a3a;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --button-primary: #C91A6A;
            --button-primary-hover: #a0155a;
        }

        /* Font Sizes */
        body.font-s { --font-scale: 0.85; }
        body.font-m { --font-scale: 1; }
        body.font-l { --font-scale: 1.15; }
        body.font-xl { --font-scale: 1.3; }
        body.font-xxl { --font-scale: 1.45; }
        body.font-super-xl { --font-scale: 1.6; }

        /* Color Themes */
        body.theme-pink-rose {
            --bg-color: #f5ebe9;
            --accent-color: #d2bcbf;
            --highlight-color: #a67980;
            --button-primary: #a67980;
            --button-primary-hover: #8d5f66;
        }

        body.theme-sage {
            --bg-color: #e8ebe5;
            --accent-color: #c0ccb8;
            --highlight-color: #60665c;
            --button-primary: #60665c;
            --button-primary-hover: #4a4f47;
        }

        body.theme-gold {
            --bg-color: #f9f3e5;
            --accent-color: #e0b558;
            --highlight-color: #ecd299;
            --button-primary: #c49840;
            --button-primary-hover: #b08838;
        }

        body.theme-periwinkle {
            --bg-color: #e5ebf5;
            --accent-color: #99b3ec;
            --highlight-color: #151b73;
            --button-primary: #151b73;
            --button-primary-hover: #1a2291;
        }

        body.theme-slate {
            --bg-color: #e5e6e8;
            --accent-color: #8386a4;
            --highlight-color: #191a22;
            --button-primary: #191a22;
            --button-primary-hover: #2a2b35;
        }

        body.theme-teal {
            --bg-color: #e5eeef;
            --accent-color: #90b2b8;
            --highlight-color: #2c4144;
            --button-primary: #2c4144;
            --button-primary-hover: #3a5559;
        }

        body.theme-ochre {
            --bg-color: #f4ebe3;
            --accent-color: #e8a760;
            --highlight-color: #c47b3f;
            --button-primary: #c47b3f;
            --button-primary-hover: #a66837;
        }

        body.theme-lavender {
            --bg-color: #f0e9f4;
            --accent-color: #c7a9d8;
            --highlight-color: #926fa8;
            --button-primary: #926fa8;
            --button-primary-hover: #7a5c8d;
        }

        body.theme-forest {
            --bg-color: #e3ebe7;
            --accent-color: #7ca68e;
            --highlight-color: #4a6356;
            --button-primary: #4a6356;
            --button-primary-hover: #3a4f44;
        }

        body.theme-coral {
            --bg-color: #f7e9e5;
            --accent-color: #f5a28a;
            --highlight-color: #eb6f4a;
            --button-primary: #eb6f4a;
            --button-primary-hover: #d75a37;
        }

        body.theme-sky {
            --bg-color: #e7f0f5;
            --accent-color: #91c4e0;
            --highlight-color: #4a8db8;
            --button-primary: #4a8db8;
            --button-primary-hover: #3e759a;
        }

        body.theme-coffee {
            --bg-color: #ebe6e1;
            --accent-color: #b39382;
            --highlight-color: #6b4332;
            --button-primary: #6b4332;
            --button-primary-hover: #563628;
        }

        body.theme-plum {
            --bg-color: #ede5ed;
            --accent-color: #b894b8;
            --highlight-color: #7d5a7d;
            --button-primary: #7d5a7d;
            --button-primary-hover: #664a66;
        }

        body.theme-sand {
            --bg-color: #eeebe6;
            --accent-color: #c9b89f;
            --highlight-color: #8c7a62;
            --button-primary: #8c7a62;
            --button-primary-hover: #736551;
        }

        body.theme-mint {
            --bg-color: #e7f0eb;
            --accent-color: #94d4b3;
            --highlight-color: #4a997a;
            --button-primary: #4a997a;
            --button-primary-hover: #3d7f65;
        }

        body.theme-blush {
            --bg-color: #f5e7ea;
            --accent-color: #e09fa9;
            --highlight-color: #c46779;
            --button-primary: #c46779;
            --button-primary-hover: #a55563;
        }

        body.theme-storm {
            --bg-color: #e8e9eb;
            --accent-color: #9499a3;
            --highlight-color: #5a5f6d;
            --button-primary: #5a5f6d;
            --button-primary-hover: #4a4f5a;
        }

        body.theme-rust {
            --bg-color: #f0e6e3;
            --accent-color: #cc8b72;
            --highlight-color: #a5593e;
            --button-primary: #a5593e;
            --button-primary-hover: #894a33;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-top: var(--safe-area-inset-top);
            padding-bottom: calc(100px + var(--safe-area-inset-bottom));
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            font-size: calc(16px * var(--font-scale));
            filter: brightness(var(--brightness)) contrast(var(--contrast));
            transition: background-color 0.3s, color 0.3s;
        }

        /* iPhone 15 Pro Max Optimization */
        @media screen and (max-width: 430px) and (max-height: 932px) {
            body {
                padding-bottom: calc(130px + var(--safe-area-inset-bottom)) !important;
            }
            
            .header {
                padding-top: calc(74px + var(--safe-area-inset-top)) !important;
                height: calc(120px + var(--safe-area-inset-top)) !important;
            }
            
            .bottom-nav {
                height: calc(120px + var(--safe-area-inset-bottom)) !important;
                padding-bottom: calc(45px + var(--safe-area-inset-bottom)) !important;
                padding-top: 18px !important;
            }
            
            .nav-item {
                padding: 16px 8px !important;
            }
            
            .nav-item svg {
                width: 32px !important;
                height: 32px !important;
            }
            
            .nav-item span {
                font-size: 13px !important;
                margin-top: 8px !important;
            }
            
            .container {
                padding-top: calc(135px + var(--safe-area-inset-top)) !important;
                padding-bottom: calc(140px + var(--safe-area-inset-bottom)) !important;
            }
            
            .modal-content {
                width: calc(100% - 24px) !important;
                margin: 12px !important;
                max-height: calc(100vh - 140px) !important;
            }
            
            .card {
                padding: 22px !important;
                margin-bottom: 22px !important;
            }
            
            .btn {
                padding: 16px 28px !important;
                font-size: 17px !important;
                min-height: 48px !important;
            }
            
            .stat-card {
                padding: 22px !important;
                min-height: 100px !important;
            }
            
            .stat-value {
                font-size: 28px !important;
            }
            
            .stat-label {
                font-size: 14px !important;
            }
        }

        .header {
            background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
            padding: calc(35px + var(--safe-area-inset-top)) 20px 25px;
            box-shadow: 0 4px 20px var(--shadow-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding-left: calc(20px + var(--safe-area-inset-left));
            padding-right: calc(20px + var(--safe-area-inset-right));
            height: calc(90px + var(--safe-area-inset-top));
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-title {
            color: white;
            font-size: calc(24px * var(--font-scale));
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-media {
            max-height: 40px;
            border-radius: 8px;
        }

        .sync-button {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: calc(14px * var(--font-scale));
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            min-width: 100px;
            text-align: center;
            position: relative;
        }

        .sync-button:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
        }

        .sync-button.syncing {
            animation: syncPulse 1s infinite;
        }

        @keyframes syncPulse {
            0% { background: rgba(255, 255, 255, 0.25); }
            50% { background: rgba(255, 255, 255, 0.45); }
            100% { background: rgba(255, 255, 255, 0.25); }
        }

        .container {
            padding: calc(115px + var(--safe-area-inset-top)) 20px calc(110px + var(--safe-area-inset-bottom)) 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding-left: calc(20px + var(--safe-area-inset-left));
            padding-right: calc(20px + var(--safe-area-inset-right));
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-color);
        }

        /* Financial Summary Card */
        .finance-summary {
            background: linear-gradient(135deg, var(--card-bg), var(--accent-color));
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 16px var(--shadow-color);
        }

        .finance-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .finance-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
        }

        .finance-label {
            font-size: calc(12px * var(--font-scale));
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .finance-value {
            font-size: calc(20px * var(--font-scale));
            font-weight: bold;
        }

        .finance-value.income {
            color: var(--income-color);
        }

        .finance-value.expense {
            color: var(--expense-color);
        }

        .finance-value.profit {
            color: var(--highlight-color);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            box-shadow: 0 -4px 20px var(--shadow-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px 10px calc(15px + var(--safe-area-inset-bottom));
            z-index: 1000;
            height: calc(90px + var(--safe-area-inset-bottom));
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item.active {
            color: var(--highlight-color);
        }

        .nav-item svg {
            width: 26px;
            height: 26px;
            fill: currentColor;
        }

        .nav-item span {
            font-size: calc(11px * var(--font-scale));
            margin-top: 4px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: calc(14px * var(--font-scale));
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: calc(16px * var(--font-scale));
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--highlight-color);
            box-shadow: 0 0 0 3px rgba(212, 124, 144, 0.1);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235a5a5a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Theme Color Boxes */
        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-option:hover {
            border-color: var(--highlight-color);
            transform: translateY(-2px);
        }

        .theme-option.selected {
            border-color: var(--highlight-color);
            background: rgba(212, 124, 144, 0.1);
        }

        .theme-color-box {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .theme-name {
            font-size: calc(12px * var(--font-scale));
            flex: 1;
        }

        /* Font Size Options */
        .font-size-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .font-size-btn {
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s;
            font-size: calc(14px * var(--font-scale));
        }

        .font-size-btn:hover {
            border-color: var(--highlight-color);
        }

        .font-size-btn.selected {
            background: var(--highlight-color);
            color: white;
            border-color: var(--highlight-color);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: calc(15px * var(--font-scale));
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--button-primary), var(--button-primary-hover));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: calc(13px * var(--font-scale));
        }

        /* Task Action Buttons */
        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .task-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: calc(12px * var(--font-scale));
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .task-action-btn.done {
            background: #10b981;
            color: white;
        }

        .task-action-btn.done:hover {
            background: #059669;
        }

        .task-action-btn.edit {
            background: #3b82f6;
            color: white;
        }

        .task-action-btn.edit:hover {
            background: #2563eb;
        }

        .task-action-btn.delete {
            background: #ef4444;
            color: white;
        }

        .task-action-btn.delete:hover {
            background: #dc2626;
        }

        /* Project Timeline Bar Chart */
        .project-timeline-chart {
            width: 100%;
            height: auto;
            min-height: 120px;
            margin: 20px 0;
            border-radius: 10px;
            background: #f9f9f9;
            padding: 15px;
            position: relative;
            overflow-x: auto;
        }

        body.night-mode .project-timeline-chart {
            background: #1a1a1a;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            font-size: calc(13px * var(--font-scale));
            color: var(--text-color);
            font-weight: 500;
        }

        body.night-mode .timeline-header {
            background: rgba(255,255,255,0.05);
        }

        .timeline-bars-container {
            position: relative;
            min-height: 80px;
            padding: 10px 0;
        }

        .timeline-bar {
            height: 40px;
            background: var(--timeline-bar-color);
            border-radius: 5px;
            margin: 8px 0;
            position: relative;
            min-width: 20px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: calc(11px * var(--font-scale));
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        .timeline-bar.completed {
            background: #10b981;
        }

        .timeline-bar.in-progress {
            background: #f39c12;
        }

        .timeline-bar.overdue {
            background: #ef4444;
        }

        /* Today Line Indicator */
        .today-line {
            position: absolute;
            width: 2px;
            height: 100%;
            background: #ff0000;
            z-index: 10;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .today-line::before {
            content: 'TODAY';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff0000;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .today-line {
            animation: pulse 2s infinite;
        }

        /* Calendar Styles */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .calendar-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: var(--accent-color);
            color: white;
            border-radius: 8px;
            font-size: calc(12px * var(--font-scale));
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: var(--card-bg);
        }

        .calendar-day:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }

        .calendar-day.today {
            border-color: #ff0000;
            background: linear-gradient(135deg, #ffe0e0, #ffcccc);
            font-weight: bold;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        body.night-mode .calendar-day.today {
            background: linear-gradient(135deg, #4a1a1a, #6a2a2a);
        }

        .calendar-day.selected {
            background: var(--highlight-color);
            color: white;
        }

        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 6px;
            height: 6px;
            background: var(--highlight-color);
            border-radius: 50%;
        }

        .day-number {
            font-size: calc(14px * var(--font-scale));
            font-weight: 500;
        }

        .event-count {
            font-size: calc(10px * var(--font-scale));
            margin-top: 2px;
            opacity: 0.7;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 2001;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: calc(20px * var(--font-scale));
            color: var(--text-color);
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--border-color);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 18px;
        }

        .modal-close:hover {
            background: var(--highlight-color);
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Quick Add Options */
        .quick-add-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }

        .quick-add-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-add-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: translateX(5px);
        }

        .quick-add-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .quick-add-title {
            font-size: calc(16px * var(--font-scale));
            font-weight: 500;
        }

        .quick-add-desc {
            font-size: calc(12px * var(--font-scale));
            opacity: 0.7;
            margin-top: 2px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .stat-value {
            font-size: calc(26px * var(--font-scale));
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: calc(13px * var(--font-scale));
            opacity: 0.9;
        }

        /* Gantt Chart */
        .gantt-container {
            overflow-x: auto;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            position: relative;
        }

        .gantt-header {
            display: flex;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        body.night-mode .gantt-header {
            background: #2a2a2a;
        }

        .gantt-month {
            flex: 1;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            border-right: 1px solid #ddd;
            font-size: calc(13px * var(--font-scale));
        }

        .gantt-tasks {
            position: relative;
            min-height: 200px;
            padding-bottom: 20px;
        }

        .gantt-task {
            position: absolute;
            background: var(--timeline-bar-color);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: calc(12px * var(--font-scale));
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            height: 32px;
            display: flex;
            align-items: center;
        }

        .gantt-task:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 5;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Project Card Task List */
        .task-list {
            margin-top: 15px;
        }

        .task-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        body.night-mode .task-item {
            background: #1a1a1a;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: calc(11px * var(--font-scale));
            font-weight: 500;
        }

        .badge.success { background: #d1fae5; color: #065f46; }
        .badge.warning { background: #fed7aa; color: #92400e; }
        .badge.danger { background: #fee2e2; color: #991b1b; }
        .badge.info { background: #dbeafe; color: #1e40af; }
        .badge.secondary { background: #e5e7eb; color: #374151; }

        body.night-mode .badge.success { background: #065f46; color: #d1fae5; }
        body.night-mode .badge.warning { background: #92400e; color: #fed7aa; }
        body.night-mode .badge.danger { background: #991b1b; color: #fee2e2; }
        body.night-mode .badge.info { background: #1e40af; color: #dbeafe; }
        body.night-mode .badge.secondary { background: #374151; color: #e5e7eb; }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            display: inline-block;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--highlight-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-title {
                font-size: calc(20px * var(--font-scale));
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .finance-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: calc(95px + var(--safe-area-inset-top)) 15px 15px;
            }
            
            .calendar {
                gap: 4px;
            }
            
            .calendar-day {
                font-size: calc(11px * var(--font-scale));
            }
            
            .nav-item span {
                font-size: calc(10px * var(--font-scale));
            }
            
            .theme-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--highlight-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: calc(85px + var(--safe-area-inset-top));
            right: 20px;
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 3000;
            font-size: calc(14px * var(--font-scale));
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-title" id="header-title" onclick="editHeaderTitle()">
                <span id="header-text">üèóÔ∏è Builder Pro v3</span>
                <img id="header-media" class="header-media" style="display: none;">
            </div>
            <button class="sync-button" onclick="syncData()" title="Click to sync">
                <span id="sync-text">‚òÅÔ∏è Sync</span>
                <span id="last-sync" style="display: block; font-size: 10px; opacity: 0.8; margin-top: 2px;"></span>
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-projects">0</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pending-tasks">0</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-budget">$0</div>
                    <div class="stat-label">Total Budget</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="net-balance">$0</div>
                    <div class="stat-label">Net Balance</div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="finance-summary">
                <h2 style="color: white; margin-bottom: 10px;">üí∞ Financial Summary</h2>
                <div class="finance-grid">
                    <div class="finance-item">
                        <div class="finance-label">Total Income</div>
                        <div class="finance-value income" id="total-income">$0.00</div>
                    </div>
                    <div class="finance-item">
                        <div class="finance-label">Total Expenses</div>
                        <div class="finance-value expense" id="total-expenses">$0.00</div>
                    </div>
                    <div class="finance-item">
                        <div class="finance-label">Net Profit</div>
                        <div class="finance-value profit" id="net-profit">$0.00</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìä Project Timeline</h2>
                <div class="gantt-container" id="home-gantt">
                    <!-- Gantt chart will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="card">
                <h2>üèóÔ∏è Projects</h2>
                <button class="btn btn-primary" onclick="openProjectModal()">+ New Project</button>
                <div id="projects-list" style="margin-top: 20px;">
                    <!-- Projects will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content">
            <div class="card">
                <h2>üìÖ Calendar</h2>
                <div id="calendar-container">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>
            
            <div class="card">
                <h2>üìä Task Timeline</h2>
                <div class="gantt-container" id="schedule-gantt">
                    <!-- Schedule gantt will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h2>‚öôÔ∏è Settings</h2>
                
                <div class="form-group">
                    <label>üèóÔ∏è App Title (Text/Media)</label>
                    <input type="text" class="form-control" id="app-title" placeholder="Enter app title or media URL">
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                        Supports: Text, YouTube/Facebook/Instagram links, or image URLs
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" class="form-control" id="user-name" placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label>Position/Title</label>
                    <input type="text" class="form-control" id="user-position" placeholder="Enter your position">
                </div>
                
                <div class="form-group">
                    <label>üåô Night Mode</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="night-mode-toggle" onchange="toggleNightMode()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>üìè Font Size</label>
                    <div class="font-size-options">
                        <button class="font-size-btn" data-size="s" onclick="changeFontSize('s')">S</button>
                        <button class="font-size-btn selected" data-size="m" onclick="changeFontSize('m')">M</button>
                        <button class="font-size-btn" data-size="l" onclick="changeFontSize('l')">L</button>
                        <button class="font-size-btn" data-size="xl" onclick="changeFontSize('xl')">XL</button>
                        <button class="font-size-btn" data-size="xxl" onclick="changeFontSize('xxl')">XXL</button>
                        <button class="font-size-btn" data-size="super-xl" onclick="changeFontSize('super-xl')">Super XL</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üé® Theme Color</label>
                    <div class="theme-options" id="theme-options">
                        <!-- Theme options will be rendered here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üîë JSONBin API Key</label>
                    <input type="password" class="form-control" id="api-key" placeholder="Enter your JSONBin API key">
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                        Get your free API key from <a href="https://jsonbin.io" target="_blank" style="color: var(--highlight-color);">JSONBin.io</a>
                    </small>
                </div>
                
                <div class="form-group">
                    <label>üì¶ Bin ID</label>
                    <input type="text" class="form-control" id="bin-id" placeholder="Enter your Bin ID or leave empty to create new">
                    <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                        Leave empty to auto-create a new bin on first sync
                    </small>
                </div>
                
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="switchTab('projects')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M10 2v2H5.5C4.67 4 4 4.67 4 5.5V11h8V8h2v3h8V5.5C22 4.67 21.33 4 20.5 4H16V2H10M4 13v6.5C4 20.33 4.67 21 5.5 21H10v-2H6v-6H4m10 6v2h4.5c.83 0 1.5-.67 1.5-1.5V13h-2v6h-4Z"/>
            </svg>
            <span>Projects</span>
        </div>
        <div class="nav-item" onclick="switchTab('schedule')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
            </svg>
            <span>Schedule</span>
        </div>
        <div class="nav-item" onclick="switchTab('settings')">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94c0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6s3.6 1.62 3.6 3.6s-1.62 3.6-3.6 3.6z"/>
            </svg>
            <span>Settings</span>
        </div>
    </div>

    <!-- Modals -->
    <!-- Calendar Date Click Modal -->
    <div id="calendar-date-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('calendar-date-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Add to Calendar</h2>
                <button class="modal-close" onclick="closeModal('calendar-date-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="quick-add-options">
                    <div class="quick-add-btn" onclick="openProjectModalForDate()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M10 2v2H5.5C4.67 4 4 4.67 4 5.5V11h8V8h2v3h8V5.5C22 4.67 21.33 4 20.5 4H16V2H10M4 13v6.5C4 20.33 4.67 21 5.5 21H10v-2H6v-6H4m10 6v2h4.5c.83 0 1.5-.67 1.5-1.5V13h-2v6h-4Z"/>
                        </svg>
                        <div>
                            <div class="quick-add-title">New Project</div>
                            <div class="quick-add-desc">Start a new construction project</div>
                        </div>
                    </div>
                    <div class="quick-add-btn" onclick="openTaskModalForDate()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <div>
                            <div class="quick-add-title">New Task</div>
                            <div class="quick-add-desc">Add a task for this date</div>
                        </div>
                    </div>
                    <div class="quick-add-btn" onclick="openTransactionModalForDate()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <div>
                            <div class="quick-add-title">New Transaction</div>
                            <div class="quick-add-desc">Record income or expense</div>
                        </div>
                    </div>
                </div>
                <div id="selected-date-events" style="margin-top: 20px;">
                    <!-- Events for selected date will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="project-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('project-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèóÔ∏è New Project</h2>
                <button class="modal-close" onclick="closeModal('project-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" class="form-control" id="project-name" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" class="form-control" id="client-name" placeholder="Enter client name">
                </div>
                <div class="form-group">
                    <label>Budget</label>
                    <input type="number" class="form-control" id="project-budget" placeholder="Enter budget">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="form-control" id="project-start-date">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" class="form-control" id="project-end-date">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="project-description" rows="3" placeholder="Enter project description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('project-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Save Project</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('task-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úÖ New Task</h2>
                <button class="modal-close" onclick="closeModal('task-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" class="form-control" id="task-name" placeholder="Enter task name">
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select class="form-control" id="task-project">
                        <option value="">Select project</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select class="form-control" id="task-priority">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="task-status">
                        <option value="Get Ready">Get Ready</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Review">Review</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" class="form-control" id="task-due-date">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="task-description" rows="3" placeholder="Enter task description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('task-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('transaction-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ New Transaction</h2>
                <button class="modal-close" onclick="closeModal('transaction-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Type</label>
                    <select class="form-control" id="transaction-type">
                        <option value="income">Income</option>
                        <option value="expense">Expense</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select class="form-control" id="transaction-project">
                        <option value="">Select project</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" class="form-control" id="transaction-amount" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" class="form-control" id="transaction-date">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" class="form-control" id="transaction-description" placeholder="Enter description">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('transaction-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTransaction()">Save Transaction</button>
            </div>
        </div>
    </div>

    <!-- Header Edit Modal -->
    <div id="header-edit-modal" class="modal">
        <div class="modal-backdrop" onclick="closeModal('header-edit-modal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit App Title</h2>
                <button class="modal-close" onclick="closeModal('header-edit-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Enter Title or Media URL</label>
                    <input type="text" class="form-control" id="header-input" placeholder="Text, YouTube/FB/IG link, or image URL">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('header-edit-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveHeaderTitle()">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <script>
        // Data Storage
        let data = {
            projects: [],
            tasks: [],
            transactions: [],
            settings: {
                userName: '',
                userPosition: '',
                theme: '',
                apiKey: '',
                binId: '',
                nightMode: false,
                fontSize: 'm',
                appTitle: 'üèóÔ∏è Builder Pro v3'
            }
        };

        // Theme Colors Configuration
        const themeColors = [
            { name: 'Default', value: '', bg: '#F4EDEB', accent: '#E8A9B3' },
            { name: 'Pink Rose', value: 'pink-rose', bg: '#f5ebe9', accent: '#d2bcbf' },
            { name: 'Sage', value: 'sage', bg: '#e8ebe5', accent: '#c0ccb8' },
            { name: 'Gold', value: 'gold', bg: '#f9f3e5', accent: '#e0b558' },
            { name: 'Periwinkle', value: 'periwinkle', bg: '#e5ebf5', accent: '#99b3ec' },
            { name: 'Slate', value: 'slate', bg: '#e5e6e8', accent: '#8386a4' },
            { name: 'Teal', value: 'teal', bg: '#e5eeef', accent: '#90b2b8' },
            { name: 'Ochre', value: 'ochre', bg: '#f4ebe3', accent: '#e8a760' },
            { name: 'Lavender', value: 'lavender', bg: '#f0e9f4', accent: '#c7a9d8' },
            { name: 'Forest', value: 'forest', bg: '#e3ebe7', accent: '#7ca68e' },
            { name: 'Coral', value: 'coral', bg: '#f7e9e5', accent: '#f5a28a' },
            { name: 'Sky', value: 'sky', bg: '#e7f0f5', accent: '#91c4e0' },
            { name: 'Coffee', value: 'coffee', bg: '#ebe6e1', accent: '#b39382' },
            { name: 'Plum', value: 'plum', bg: '#ede5ed', accent: '#b894b8' },
            { name: 'Sand', value: 'sand', bg: '#eeebe6', accent: '#c9b89f' },
            { name: 'Mint', value: 'mint', bg: '#e7f0eb', accent: '#94d4b3' },
            { name: 'Blush', value: 'blush', bg: '#f5e7ea', accent: '#e09fa9' },
            { name: 'Storm', value: 'storm', bg: '#e8e9eb', accent: '#9499a3' },
            { name: 'Rust', value: 'rust', bg: '#f0e6e3', accent: '#cc8b72' }
        ];

        // Selected date for calendar
        let selectedDate = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderHome();
            renderThemeOptions();
            generateIcons();
            checkViewportHeight();
            updateHeaderTitle();
            updateLastSyncDisplay();
            
            // Auto-sync on load if configured (with delay to ensure everything is loaded)
            if (data.settings.apiKey) {
                setTimeout(() => {
                    syncData();
                }, 2000);
            }
            
            // Update last sync display every minute
            setInterval(updateLastSyncDisplay, 60000);
            
            // Auto-sync every 5 minutes if configured
            setInterval(() => {
                if (data.settings.apiKey) {
                    syncData();
                }
            }, 300000); // 5 minutes
        });

        // Update Last Sync Display
        function updateLastSyncDisplay() {
            const lastSyncElement = document.getElementById('last-sync');
            
            if (data.lastSync) {
                const lastSyncDate = new Date(data.lastSync);
                const now = new Date();
                const diffMs = now - lastSyncDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                let timeAgo = '';
                if (diffMins < 1) {
                    timeAgo = 'Just now';
                } else if (diffMins < 60) {
                    timeAgo = `${diffMins}m ago`;
                } else if (diffHours < 24) {
                    timeAgo = `${diffHours}h ago`;
                } else {
                    timeAgo = `${diffDays}d ago`;
                }
                
                lastSyncElement.textContent = timeAgo;
                lastSyncElement.style.display = 'block';
            } else {
                lastSyncElement.textContent = 'Never synced';
                lastSyncElement.style.display = 'block';
            }
        }

        // Set PWA Icons using the GitHub image
        function generateIcons() {
            // Use the actual image from your GitHub repository
            // The correct raw GitHub URL format
            const iconUrl = 'https://raw.githubusercontent.com/lyode/Builder-Pro/main/images_copy.png';
            
            // Create an image element to load the icon
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                // Set all icon sizes to use the same image
                document.getElementById('icon180').href = iconUrl;
                document.getElementById('icon152').href = iconUrl;
                document.getElementById('icon120').href = iconUrl;
                document.getElementById('favicon').href = iconUrl;
                
                console.log('Icons loaded successfully');
            };
            
            img.onerror = function() {
                // Fallback to a data URL icon if GitHub image fails
                console.log('Failed to load GitHub icon, using fallback');
                const fallbackIcon = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImEiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNFOEE5QjMiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNENDdDOTAiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0idXJsKCNhKSIvPjx0ZXh0IHg9IjI1NiIgeT0iMjgwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAwIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkI8L3RleHQ+PC9zdmc+';
                
                document.getElementById('icon180').href = fallbackIcon;
                document.getElementById('icon152').href = fallbackIcon;
                document.getElementById('icon120').href = fallbackIcon;
                document.getElementById('favicon').href = fallbackIcon;
            };
            
            img.src = iconUrl;
            
            // Also set up manifest for PWA
            const manifest = {
                name: 'Builder Pro v3',
                short_name: 'Builder Pro',
                description: 'Professional Project Management App',
                start_url: '/',
                display: 'standalone',
                background_color: '#E8A9B3',
                theme_color: '#E8A9B3',
                orientation: 'portrait',
                icons: [
                    {
                        src: iconUrl,
                        sizes: '192x192',
                        type: 'image/png',
                        purpose: 'any maskable'
                    },
                    {
                        src: iconUrl,
                        sizes: '512x512',
                        type: 'image/png',
                        purpose: 'any maskable'
                    }
                ]
            };
            
            // Create and inject manifest
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            
            let manifestLink = document.querySelector('link[rel="manifest"]');
            if (!manifestLink) {
                manifestLink = document.createElement('link');
                manifestLink.rel = 'manifest';
                document.head.appendChild(manifestLink);
            }
            manifestLink.href = manifestUrl;
            
            // Set meta theme color
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) {
                metaTheme.content = '#E8A9B3';
            }
        }

        // Check viewport height for iPhone
        function checkViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        window.addEventListener('resize', checkViewportHeight);
        window.addEventListener('orientationchange', checkViewportHeight);

        // Load Data
        function loadData() {
            const stored = localStorage.getItem('builderProData');
            if (stored) {
                data = JSON.parse(stored);
                applySettings();
            }
        }

        // Save Data
        function saveData() {
            localStorage.setItem('builderProData', JSON.stringify(data));
        }

        // Apply Settings
        function applySettings() {
            // Apply theme
            if (data.settings.theme) {
                document.body.className = `theme-${data.settings.theme}`;
            }
            
            // Apply night mode
            if (data.settings.nightMode) {
                document.body.classList.add('night-mode');
                document.getElementById('night-mode-toggle').checked = true;
            }
            
            // Apply font size
            if (data.settings.fontSize) {
                changeFontSize(data.settings.fontSize, false);
            }
            
            // Update user info
            if (data.settings.userName) {
                document.getElementById('user-name').value = data.settings.userName;
            }
            if (data.settings.userPosition) {
                document.getElementById('user-position').value = data.settings.userPosition;
            }
            if (data.settings.apiKey) {
                document.getElementById('api-key').value = data.settings.apiKey;
            }
            if (data.settings.binId) {
                document.getElementById('bin-id').value = data.settings.binId;
            }
            if (data.settings.appTitle) {
                document.getElementById('app-title').value = data.settings.appTitle;
            }
        }

        // Update Header Title
        function updateHeaderTitle() {
            const title = data.settings.appTitle || 'üèóÔ∏è Builder Pro v3';
            const headerText = document.getElementById('header-text');
            const headerMedia = document.getElementById('header-media');
            
            // Check if it's a URL
            if (title.includes('http') || title.includes('www')) {
                // Check if it's an image
                if (title.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                    headerText.style.display = 'none';
                    headerMedia.src = title;
                    headerMedia.style.display = 'block';
                } else if (title.includes('youtube.com') || title.includes('youtu.be')) {
                    // YouTube embed
                    const videoId = extractYouTubeId(title);
                    if (videoId) {
                        headerText.innerHTML = `<iframe width="120" height="40" src="https://www.youtube.com/embed/${videoId}" frameborder="0" style="border-radius: 8px;"></iframe>`;
                    }
                } else {
                    // Other links - show as clickable link
                    headerText.innerHTML = `<a href="${title}" target="_blank" style="color: white; text-decoration: none;">üîó Link</a>`;
                }
            } else {
                // Regular text
                headerText.style.display = 'block';
                headerText.textContent = title;
                headerMedia.style.display = 'none';
            }
        }

        // Extract YouTube Video ID
        function extractYouTubeId(url) {
            const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/);
            return match ? match[1] : null;
        }

        // Edit Header Title
        function editHeaderTitle() {
            document.getElementById('header-input').value = data.settings.appTitle || '';
            openModal('header-edit-modal');
        }

        // Save Header Title
        function saveHeaderTitle() {
            const newTitle = document.getElementById('header-input').value;
            data.settings.appTitle = newTitle || 'üèóÔ∏è Builder Pro v3';
            saveData();
            updateHeaderTitle();
            closeModal('header-edit-modal');
            showToast('Header updated', 'success');
        }

        // Render Theme Options
        function renderThemeOptions() {
            const container = document.getElementById('theme-options');
            
            container.innerHTML = themeColors.map(theme => `
                <div class="theme-option ${data.settings.theme === theme.value ? 'selected' : ''}" 
                     onclick="changeTheme('${theme.value}')" data-theme="${theme.value}">
                    <div class="theme-color-box" style="background: linear-gradient(135deg, ${theme.bg}, ${theme.accent});"></div>
                    <div class="theme-name">${theme.name}</div>
                </div>
            `).join('');
        }

        // Toggle Night Mode
        function toggleNightMode() {
            const isChecked = document.getElementById('night-mode-toggle').checked;
            
            if (isChecked) {
                document.body.classList.add('night-mode');
            } else {
                document.body.classList.remove('night-mode');
            }
            
            data.settings.nightMode = isChecked;
            saveData();
        }

        // Change Font Size
        function changeFontSize(size, save = true) {
            // Remove all font size classes
            document.body.classList.remove('font-s', 'font-m', 'font-l', 'font-xl', 'font-xxl', 'font-super-xl');
            
            // Add new font size class
            document.body.classList.add(`font-${size}`);
            
            // Update button states
            document.querySelectorAll('.font-size-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.size === size) {
                    btn.classList.add('selected');
                }
            });
            
            data.settings.fontSize = size;
            
            if (save) {
                saveData();
            }
        }

        // Switch Tab
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active to selected nav item
            event.currentTarget.classList.add('active');
            
            // Render tab content
            switch(tabName) {
                case 'home':
                    renderHome();
                    break;
                case 'projects':
                    renderProjects();
                    break;
                case 'schedule':
                    renderSchedule();
                    break;
            }
        }

        // Render Home
        function renderHome() {
            // Update stats
            document.getElementById('total-projects').textContent = data.projects.length;
            
            // Filter out completed tasks
            const pendingTasks = data.tasks.filter(t => t.status !== 'Completed');
            document.getElementById('pending-tasks').textContent = pendingTasks.length;
            
            // Calculate financials
            let totalBudget = data.projects.reduce((sum, p) => sum + (parseFloat(p.budget) || 0), 0);
            let totalIncome = data.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            let totalExpense = data.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            let netProfit = totalIncome - totalExpense;
            
            document.getElementById('total-budget').textContent = `$${totalBudget.toFixed(2)}`;
            document.getElementById('net-balance').textContent = `$${netProfit.toFixed(2)}`;
            
            // Update financial summary
            document.getElementById('total-income').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('total-expenses').textContent = `$${totalExpense.toFixed(2)}`;
            document.getElementById('net-profit').textContent = `$${netProfit.toFixed(2)}`;
            
            // Render Gantt Chart
            renderGanttChart('home-gantt');
        }

        // Render Projects
        function renderProjects() {
            const container = document.getElementById('projects-list');
            
            if (data.projects.length === 0) {
                container.innerHTML = '<div class="empty-state">No projects yet. Click "+ New Project" to get started!</div>';
                return;
            }
            
            container.innerHTML = data.projects.map(project => {
                // Filter tasks - exclude completed ones
                const tasks = data.tasks.filter(t => t.projectId === project.id && t.status !== 'Completed');
                const completedTasks = data.tasks.filter(t => t.projectId === project.id && t.status === 'Completed');
                const income = data.transactions.filter(t => t.projectId === project.id && t.type === 'income');
                const expenses = data.transactions.filter(t => t.projectId === project.id && t.type === 'expense');
                
                // Calculate project financials
                const projectIncome = income.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const projectExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const projectProfit = projectIncome - projectExpenses;
                
                return `
                    <div class="card">
                        <h3>${project.name}</h3>
                        <div style="color: var(--text-secondary); margin-top: 5px;">
                            Client: ${project.client} ‚Ä¢ Budget: $${parseFloat(project.budget || 0).toFixed(2)}
                        </div>
                        <div style="margin-top: 10px; font-size: 14px;">
                            üìÖ ${formatDate(project.startDate)} - ${formatDate(project.endDate)}
                        </div>
                        
                        <!-- Project Financial Summary -->
                        <div class="finance-grid" style="margin-top: 15px;">
                            <div class="finance-item">
                                <div class="finance-label">Income</div>
                                <div class="finance-value income">$${projectIncome.toFixed(2)}</div>
                            </div>
                            <div class="finance-item">
                                <div class="finance-label">Expenses</div>
                                <div class="finance-value expense">$${projectExpenses.toFixed(2)}</div>
                            </div>
                            <div class="finance-item">
                                <div class="finance-label">Net Profit</div>
                                <div class="finance-value profit">$${projectProfit.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <!-- Project Timeline Chart -->
                        <div class="project-timeline-chart" id="project-timeline-${project.id}">
                            ${renderProjectTimeline(project)}
                        </div>
                        
                        <!-- Active Tasks Section -->
                        <div style="margin-top: 20px;">
                            <h4>Active Tasks (${tasks.length}) ${completedTasks.length > 0 ? `<span style="color: var(--text-secondary); font-size: 12px;">[${completedTasks.length} completed]</span>` : ''}</h4>
                            <div class="task-list">
                                ${tasks.length > 0 ? tasks.map(task => `
                                    <div class="task-item">
                                        <div class="task-header">
                                            <div>
                                                <strong>${task.name}</strong>
                                                <span class="badge ${getStatusColor(task.status)}" style="margin-left: 10px;">${task.status}</span>
                                            </div>
                                            <span class="badge ${getPriorityColor(task.priority)}">${task.priority}</span>
                                        </div>
                                        ${task.dueDate ? `<div style="margin-top: 5px; font-size: 12px; color: var(--text-secondary);">üìÖ ${formatDate(task.dueDate)}</div>` : ''}
                                        <div class="task-actions">
                                            <button class="task-action-btn done" onclick="markTaskDone('${task.id}')">‚úì Done</button>
                                            <button class="task-action-btn edit" onclick="editTask('${task.id}')">‚úèÔ∏è Edit</button>
                                            <button class="task-action-btn delete" onclick="deleteTask('${task.id}')">üóëÔ∏è Delete</button>
                                        </div>
                                    </div>
                                `).join('') : '<div style="padding: 10px; color: var(--text-secondary);">No active tasks</div>'}
                            </div>
                            <button class="btn btn-sm btn-primary" style="margin-top: 10px;" onclick="openTaskModalForProject('${project.id}')">+ Add Task</button>
                        </div>
                        
                        <!-- Financial Details -->
                        <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <h4 style="color: var(--income-color);">Income Entries</h4>
                                ${income.length > 0 ? income.map(t => `
                                    <div style="padding: 8px; background: #f0fdf4; border-radius: 6px; margin-top: 8px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <strong>$${parseFloat(t.amount).toFixed(2)}</strong>
                                            <span style="font-size: 11px; color: var(--text-secondary);">${formatDate(t.date)}</span>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${t.description}</div>
                                    </div>
                                `).join('') : '<div style="padding: 10px; color: var(--text-secondary);">No income entries</div>'}
                            </div>
                            <div>
                                <h4 style="color: var(--expense-color);">Expense Entries</h4>
                                ${expenses.length > 0 ? expenses.map(t => `
                                    <div style="padding: 8px; background: #fef2f2; border-radius: 6px; margin-top: 8px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <strong>$${parseFloat(t.amount).toFixed(2)}</strong>
                                            <span style="font-size: 11px; color: var(--text-secondary);">${formatDate(t.date)}</span>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${t.description}</div>
                                    </div>
                                `).join('') : '<div style="padding: 10px; color: var(--text-secondary);">No expense entries</div>'}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <button class="btn btn-sm btn-primary" onclick="openTransactionModalForProject('${project.id}')">+ Add Transaction</button>
                            <button class="btn btn-sm btn-secondary" onclick="editProject('${project.id}')">Edit Project</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProject('${project.id}')">Delete Project</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Project Timeline
        function renderProjectTimeline(project) {
            const tasks = data.tasks.filter(t => t.projectId === project.id && t.dueDate);
            
            if (!project.startDate || !project.endDate) {
                return '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No timeline dates set</div>';
            }
            
            if (tasks.length === 0) {
                return '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No tasks with due dates</div>';
            }
            
            const startDate = new Date(project.startDate);
            const endDate = new Date(project.endDate);
            const today = new Date();
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const todayPosition = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
            const todayPercent = (todayPosition / totalDays) * 100;
            
            // Calculate project duration
            const durationDays = totalDays;
            const durationWeeks = Math.floor(durationDays / 7);
            const remainingDays = durationDays % 7;
            let durationText = '';
            if (durationWeeks > 0) {
                durationText = `${durationWeeks} week${durationWeeks > 1 ? 's' : ''}`;
                if (remainingDays > 0) {
                    durationText += ` ${remainingDays} day${remainingDays > 1 ? 's' : ''}`;
                }
            } else {
                durationText = `${durationDays} day${durationDays > 1 ? 's' : ''}`;
            }
            
            let html = `
                <div class="timeline-header">
                    <span>üìÖ ${formatDate(project.startDate)}</span>
                    <span style="font-weight: bold;">Duration: ${durationText}</span>
                    <span>üèÅ ${formatDate(project.endDate)}</span>
                </div>
                <div class="timeline-bars-container">
            `;
            
            // Add today line
            if (todayPercent >= 0 && todayPercent <= 100) {
                html += `<div class="today-line" style="left: ${todayPercent}%;"></div>`;
            }
            
            // Add task bars with dates
            tasks.forEach(task => {
                const taskDate = new Date(task.dueDate);
                const taskPosition = Math.ceil((taskDate - startDate) / (1000 * 60 * 60 * 24));
                const taskPercent = (taskPosition / totalDays) * 100;
                
                // Calculate days until task
                const daysUntilTask = Math.ceil((taskDate - today) / (1000 * 60 * 60 * 24));
                let daysText = '';
                if (daysUntilTask === 0) {
                    daysText = 'Today';
                } else if (daysUntilTask === 1) {
                    daysText = 'Tomorrow';
                } else if (daysUntilTask > 0) {
                    daysText = `In ${daysUntilTask} days`;
                } else {
                    daysText = `${Math.abs(daysUntilTask)} days ago`;
                }
                
                let statusClass = '';
                if (task.status === 'Completed') statusClass = 'completed';
                else if (task.status === 'In Progress') statusClass = 'in-progress';
                else if (taskDate < today && task.status !== 'Completed') statusClass = 'overdue';
                
                html += `
                    <div class="timeline-bar ${statusClass}" 
                         style="width: ${Math.max(15, 100 - taskPercent)}%; margin-left: ${Math.min(85, taskPercent)}%;"
                         title="${task.name} - ${formatDate(task.dueDate)} (${daysText})">
                        <span style="font-size: 10px; opacity: 0.9;">${formatDate(task.dueDate).split(',')[0]}</span> ${task.name}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // Render Schedule
        function renderSchedule() {
            renderCalendar();
            renderGanttChart('schedule-gantt');
        }

        // Render Calendar
        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const lastDateOfMonth = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3>${monthNames[month]} ${year}</h3>
                </div>
                <div class="calendar">
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>
            `;
            
            // Previous month days
            for (let i = firstDayOfWeek; i > 0; i--) {
                html += `<div class="calendar-day" style="opacity: 0.3;">
                    <div class="day-number">${prevLastDate - i + 1}</div>
                </div>`;
            }
            
            // Current month days
            for (let i = 1; i <= lastDateOfMonth; i++) {
                const date = new Date(year, month, i);
                const dateStr = date.toISOString().split('T')[0];
                const events = getEventsForDate(dateStr);
                const isToday = i === now.getDate() && month === now.getMonth() && year === now.getFullYear();
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${events.length > 0 ? 'has-event' : ''}"
                         onclick="onCalendarDateClick('${dateStr}')">
                        <div class="day-number">${i}</div>
                        ${events.length > 0 ? `<div class="event-count">${events.length}</div>` : ''}
                    </div>
                `;
            }
            
            // Next month days
            const remainingDays = 42 - (firstDayOfWeek + lastDateOfMonth);
            for (let i = 1; i <= remainingDays; i++) {
                html += `<div class="calendar-day" style="opacity: 0.3;">
                    <div class="day-number">${i}</div>
                </div>`;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Get Events for Date
        function getEventsForDate(dateStr) {
            const events = [];
            
            // Check tasks (exclude completed)
            data.tasks.forEach(task => {
                if (task.dueDate === dateStr && task.status !== 'Completed') {
                    events.push({ type: 'task', data: task });
                }
            });
            
            // Check projects
            data.projects.forEach(project => {
                if (project.startDate === dateStr || project.endDate === dateStr) {
                    events.push({ type: 'project', data: project });
                }
            });
            
            // Check transactions
            data.transactions.forEach(transaction => {
                if (transaction.date === dateStr) {
                    events.push({ type: 'transaction', data: transaction });
                }
            });
            
            return events;
        }

        // On Calendar Date Click
        function onCalendarDateClick(dateStr) {
            selectedDate = dateStr;
            const modal = document.getElementById('calendar-date-modal');
            const eventsContainer = document.getElementById('selected-date-events');
            const events = getEventsForDate(dateStr);
            
            // Display events for selected date
            if (events.length > 0) {
                eventsContainer.innerHTML = `
                    <h3>Events on ${formatDate(dateStr)}</h3>
                    ${events.map(event => {
                        if (event.type === 'task') {
                            return `
                                <div style="padding: 10px; background: #f9f9f9; border-radius: 8px; margin-top: 10px;">
                                    <div style="font-weight: 500;">üìã Task: ${event.data.name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${event.data.status}</div>
                                </div>
                            `;
                        } else if (event.type === 'project') {
                            return `
                                <div style="padding: 10px; background: #f9f9f9; border-radius: 8px; margin-top: 10px;">
                                    <div style="font-weight: 500;">üèóÔ∏è Project: ${event.data.name}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        ${event.data.startDate === dateStr ? 'Start Date' : 'End Date'}
                                    </div>
                                </div>
                            `;
                        } else if (event.type === 'transaction') {
                            return `
                                <div style="padding: 10px; background: #f9f9f9; border-radius: 8px; margin-top: 10px;">
                                    <div style="font-weight: 500;">üí∞ ${event.data.type === 'income' ? 'Income' : 'Expense'}: $${event.data.amount}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${event.data.description}</div>
                                </div>
                            `;
                        }
                    }).join('')}
                `;
            } else {
                eventsContainer.innerHTML = `<div style="text-align: center; color: var(--text-secondary);">No events on ${formatDate(dateStr)}</div>`;
            }
            
            modal.classList.add('active');
        }

        // Open Project Modal for Date
        function openProjectModalForDate() {
            closeModal('calendar-date-modal');
            openProjectModal();
            if (selectedDate) {
                document.getElementById('project-start-date').value = selectedDate;
            }
        }

        // Open Task Modal for Date
        function openTaskModalForDate() {
            closeModal('calendar-date-modal');
            openTaskModal();
            if (selectedDate) {
                document.getElementById('task-due-date').value = selectedDate;
            }
        }

        // Open Task Modal for Project
        function openTaskModalForProject(projectId) {
            openTaskModal();
            document.getElementById('task-project').value = projectId;
        }

        // Open Transaction Modal for Date
        function openTransactionModalForDate() {
            closeModal('calendar-date-modal');
            openTransactionModal();
            if (selectedDate) {
                document.getElementById('transaction-date').value = selectedDate;
            }
        }

        // Open Transaction Modal for Project
        function openTransactionModalForProject(projectId) {
            openTransactionModal();
            document.getElementById('transaction-project').value = projectId;
        }

        // Render Gantt Chart
        function renderGanttChart(containerId) {
            const container = document.getElementById(containerId);
            const projects = data.projects.filter(p => p.startDate && p.endDate);
            
            if (projects.length === 0) {
                container.innerHTML = '<div class="empty-state">No projects with dates</div>';
                return;
            }
            
            const today = new Date();
            const months = getMonthsRange();
            
            let html = `
                <div class="gantt-header">
                    ${months.map(m => `<div class="gantt-month">${m}</div>`).join('')}
                </div>
                <div class="gantt-tasks" style="position: relative; min-height: ${projects.length * 60}px;">
            `;
            
            // Calculate today position
            const firstDate = new Date(months[0] + ' 1');
            const lastDate = new Date(months[months.length - 1] + ' 28');
            const totalDays = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24));
            const todayPosition = Math.ceil((today - firstDate) / (1000 * 60 * 60 * 24));
            const todayPercent = (todayPosition / totalDays) * 100;
            
            // Add today line
            if (todayPercent >= 0 && todayPercent <= 100) {
                html += `<div class="today-line" style="left: ${todayPercent}%;"></div>`;
            }
            
            // Add project bars with duration info
            projects.forEach((project, index) => {
                const startDate = new Date(project.startDate);
                const endDate = new Date(project.endDate);
                
                // Calculate duration
                const durationDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                const durationWeeks = Math.floor(durationDays / 7);
                const remainingDays = durationDays % 7;
                let durationText = '';
                if (durationWeeks > 0) {
                    durationText = `${durationWeeks}w`;
                    if (remainingDays > 0) {
                        durationText += ` ${remainingDays}d`;
                    }
                } else {
                    durationText = `${durationDays}d`;
                }
                
                const startPos = Math.ceil((startDate - firstDate) / (1000 * 60 * 60 * 24));
                const endPos = Math.ceil((endDate - firstDate) / (1000 * 60 * 60 * 24));
                
                const left = (startPos / totalDays) * 100;
                const width = ((endPos - startPos) / totalDays) * 100;
                
                html += `
                    <div class="gantt-task" style="
                        top: ${index * 60}px;
                        left: ${Math.max(0, left)}%;
                        width: ${Math.min(100 - left, width)}%;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 8px 12px;
                    " title="${project.name}: ${formatDate(project.startDate)} - ${formatDate(project.endDate)} (${durationText})">
                        <span style="font-weight: bold;">${project.name}</span>
                        <span style="font-size: 11px; opacity: 0.9;">${durationText}</span>
                    </div>
                    <div style="
                        position: absolute;
                        top: ${index * 60 + 35}px;
                        left: ${Math.max(0, left)}%;
                        font-size: 10px;
                        color: var(--text-secondary);
                        white-space: nowrap;
                    ">
                        ${formatDate(project.startDate).split(',')[0]} ‚Üí ${formatDate(project.endDate).split(',')[0]}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Get Months Range
        function getMonthsRange() {
            const months = [];
            const now = new Date();
            
            for (let i = -2; i <= 3; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                months.push(`${monthNames[date.getMonth()]} ${date.getFullYear()}`);
            }
            
            return months;
        }

        // Task Actions
        function markTaskDone(taskId) {
            const task = data.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'Completed';
                task.updatedAt = new Date().toISOString();
                saveData();
                renderHome();
                renderProjects();
                showToast('Task marked as completed', 'success');
            }
        }

        function editTask(taskId) {
            const task = data.tasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('task-name').value = task.name;
                document.getElementById('task-project').value = task.projectId || '';
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-status').value = task.status;
                document.getElementById('task-due-date').value = task.dueDate || '';
                document.getElementById('task-description').value = task.description || '';
                
                // Store task ID for update
                document.getElementById('task-modal').dataset.editId = taskId;
                
                openModal('task-modal');
            }
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                data.tasks = data.tasks.filter(t => t.id !== taskId);
                saveData();
                renderHome();
                renderProjects();
                showToast('Task deleted', 'success');
            }
        }

        // Project Actions
        function editProject(projectId) {
            const project = data.projects.find(p => p.id === projectId);
            if (project) {
                document.getElementById('project-name').value = project.name;
                document.getElementById('client-name').value = project.client;
                document.getElementById('project-budget').value = project.budget;
                document.getElementById('project-start-date').value = project.startDate;
                document.getElementById('project-end-date').value = project.endDate;
                document.getElementById('project-description').value = project.description || '';
                
                // Store project ID for update
                document.getElementById('project-modal').dataset.editId = projectId;
                
                openModal('project-modal');
            }
        }

        function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project? All related tasks and transactions will also be deleted.')) {
                data.projects = data.projects.filter(p => p.id !== projectId);
                data.tasks = data.tasks.filter(t => t.projectId !== projectId);
                data.transactions = data.transactions.filter(t => t.projectId !== projectId);
                saveData();
                renderProjects();
                renderHome();
                showToast('Project deleted', 'success');
            }
        }

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            delete modal.dataset.editId;
        }

        function openProjectModal() {
            populateProjectSelect();
            openModal('project-modal');
        }

        function openTaskModal() {
            populateProjectSelect();
            openModal('task-modal');
        }

        function openTransactionModal() {
            populateProjectSelect();
            openModal('transaction-modal');
        }

        // Populate Project Select
        function populateProjectSelect() {
            const selects = ['task-project', 'transaction-project'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select project</option>' +
                        data.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                }
            });
        }

        // Save Functions
        function saveProject() {
            const modal = document.getElementById('project-modal');
            const editId = modal.dataset.editId;
            const now = new Date().toISOString();
            
            const projectData = {
                id: editId || Date.now().toString(),
                name: document.getElementById('project-name').value,
                client: document.getElementById('client-name').value,
                budget: document.getElementById('project-budget').value,
                startDate: document.getElementById('project-start-date').value,
                endDate: document.getElementById('project-end-date').value,
                description: document.getElementById('project-description').value,
                createdAt: editId ? (data.projects.find(p => p.id === editId)?.createdAt || now) : now,
                updatedAt: now
            };
            
            if (!projectData.name || !projectData.client) {
                showToast('Please fill in required fields', 'error');
                return;
            }
            
            if (editId) {
                const index = data.projects.findIndex(p => p.id === editId);
                data.projects[index] = projectData;
            } else {
                data.projects.push(projectData);
            }
            
            saveData();
            closeModal('project-modal');
            renderProjects();
            renderHome();
            showToast(editId ? 'Project updated' : 'Project created', 'success');
        }

        function saveTask() {
            const modal = document.getElementById('task-modal');
            const editId = modal.dataset.editId;
            const now = new Date().toISOString();
            
            const taskData = {
                id: editId || Date.now().toString(),
                name: document.getElementById('task-name').value,
                projectId: document.getElementById('task-project').value,
                priority: document.getElementById('task-priority').value,
                status: document.getElementById('task-status').value,
                dueDate: document.getElementById('task-due-date').value,
                description: document.getElementById('task-description').value,
                createdAt: editId ? (data.tasks.find(t => t.id === editId)?.createdAt || now) : now,
                updatedAt: now
            };
            
            if (!taskData.name) {
                showToast('Please enter a task name', 'error');
                return;
            }
            
            if (editId) {
                const index = data.tasks.findIndex(t => t.id === editId);
                data.tasks[index] = taskData;
            } else {
                data.tasks.push(taskData);
            }
            
            saveData();
            closeModal('task-modal');
            renderProjects();
            renderHome();
            showToast(editId ? 'Task updated' : 'Task created', 'success');
        }

        function saveTransaction() {
            const now = new Date().toISOString();
            
            const transactionData = {
                id: Date.now().toString(),
                type: document.getElementById('transaction-type').value,
                projectId: document.getElementById('transaction-project').value,
                amount: document.getElementById('transaction-amount').value,
                date: document.getElementById('transaction-date').value,
                description: document.getElementById('transaction-description').value,
                createdAt: now,
                updatedAt: now
            };
            
            if (!transactionData.amount || !transactionData.description) {
                showToast('Please fill in required fields', 'error');
                return;
            }
            
            data.transactions.push(transactionData);
            saveData();
            closeModal('transaction-modal');
            renderProjects();
            renderHome();
            showToast('Transaction saved', 'success');
        }

        // Settings Functions
        function changeTheme(theme) {
            // Remove all theme classes
            themeColors.forEach(t => {
                if (t.value) {
                    document.body.classList.remove(`theme-${t.value}`);
                }
            });
            
            // Add new theme class
            if (theme) {
                document.body.classList.add(`theme-${theme}`);
            }
            
            // Update selection state
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.theme === theme) {
                    option.classList.add('selected');
                }
            });
            
            data.settings.theme = theme;
            saveData();
        }

        function saveSettings() {
            data.settings.userName = document.getElementById('user-name').value;
            data.settings.userPosition = document.getElementById('user-position').value;
            data.settings.appTitle = document.getElementById('app-title').value || 'üèóÔ∏è Builder Pro v3';
            data.settings.apiKey = document.getElementById('api-key').value;
            data.settings.binId = document.getElementById('bin-id').value;
            
            saveData();
            updateHeaderTitle();
            showToast('Settings saved', 'success');
        }

        // Smart Sync Functions
        async function syncData() {
            console.log('Starting sync process...');
            const syncButton = document.getElementById('sync-text').parentElement;
            const syncText = document.getElementById('sync-text');
            
            if (!data.settings.apiKey) {
                console.log('Missing API key');
                showToast('Please enter your JSONBin API key in Settings', 'warning');
                switchTab('settings');
                return;
            }
            
            // Ensure we have valid API credentials
            const apiKey = data.settings.apiKey.trim();
            const binId = data.settings.binId.trim();
            
            console.log('API Key present:', !!apiKey);
            console.log('Bin ID:', binId || 'Will create new');
            
            if (!apiKey) {
                showToast('Please enter your JSONBin API key in Settings', 'error');
                return;
            }
            
            syncButton.classList.add('syncing');
            syncText.textContent = 'Smart Syncing...';
            
            try {
                // Add timestamps to local data before sync
                addTimestamps();
                
                if (binId) {
                    // Try to fetch existing data
                    console.log('Fetching from existing bin:', binId);
                    const pullResponse = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Access-Key': apiKey,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('Fetch response status:', pullResponse.status);
                    let syncResult = { added: 0, updated: 0, conflicts: 0 };
                    
                    if (pullResponse.ok) {
                        const remoteData = await pullResponse.json();
                        console.log('Remote data fetched successfully');
                        
                        // Smart merge - intelligently combine local and remote data
                        syncResult = smartMergeData(remoteData.record);
                        
                        // Push merged data back to JSONBin
                        console.log('Pushing merged data back...');
                        const pushResponse = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Access-Key': apiKey
                            },
                            body: JSON.stringify(data)
                        });
                        
                        console.log('Push response status:', pushResponse.status);
                        
                        if (pushResponse.ok) {
                            syncButton.classList.remove('syncing');
                            syncText.textContent = '‚úÖ Smart Synced';
                            
                            // Show detailed sync results
                            let message = 'Smart Sync Complete! ';
                            if (syncResult.added > 0) message += `Added: ${syncResult.added} `;
                            if (syncResult.updated > 0) message += `Updated: ${syncResult.updated} `;
                            if (syncResult.conflicts > 0) message += `Conflicts resolved: ${syncResult.conflicts}`;
                            if (syncResult.added === 0 && syncResult.updated === 0 && syncResult.conflicts === 0) {
                                message = 'Already up to date!';
                            }
                            
                            showToast(message, 'success');
                            
                            // Update last sync time
                            data.lastSync = new Date().toISOString();
                            saveData();
                            updateLastSyncDisplay();
                            
                            setTimeout(() => {
                                syncText.textContent = '‚òÅÔ∏è Sync';
                            }, 2000);
                        } else {
                            const errorText = await pushResponse.text();
                            throw new Error(`Push failed: ${errorText}`);
                        }
                    } else {
                        const errorText = await pullResponse.text();
                        throw new Error(`Fetch failed: ${errorText}`);
                    }
                } else {
                    // No bin ID, create new bin
                    console.log('Creating new bin...');
                    const createResponse = await fetch(`https://api.jsonbin.io/v3/b`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Access-Key': apiKey,
                            'X-Bin-Name': 'Builder Pro Data'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    console.log('Create response status:', createResponse.status);
                    
                    if (createResponse.ok) {
                        const result = await createResponse.json();
                        data.settings.binId = result.metadata.id;
                        document.getElementById('bin-id').value = result.metadata.id;
                        data.lastSync = new Date().toISOString();
                        saveData();
                        updateLastSyncDisplay();
                        
                        syncButton.classList.remove('syncing');
                        syncText.textContent = '‚úÖ Created & Synced';
                        showToast(`Cloud storage created! Bin ID: ${result.metadata.id}`, 'success');
                        console.log('New bin created:', result.metadata.id);
                        
                        setTimeout(() => {
                            syncText.textContent = '‚òÅÔ∏è Sync';
                        }, 2000);
                    } else {
                        const errorText = await createResponse.text();
                        throw new Error(`Create failed: ${errorText}`);
                    }
                }
                
                // Refresh current view
                renderHome();
                renderProjects();
                
            } catch (error) {
                console.error('Sync error:', error);
                syncButton.classList.remove('syncing');
                syncText.textContent = '‚ùå Sync Error';
                
                // Provide more helpful error messages
                let errorMessage = 'Smart Sync failed: ';
                if (error.message.includes('401')) {
                    errorMessage += 'Invalid API key. Please check your JSONBin API key.';
                } else if (error.message.includes('404')) {
                    errorMessage += 'Bin not found. Clear Bin ID to create a new one.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage += 'Network error. Check your internet connection.';
                } else {
                    errorMessage += error.message;
                }
                
                showToast(errorMessage, 'error');
                setTimeout(() => {
                    syncText.textContent = '‚òÅÔ∏è Sync';
                }, 3000);
            }
        }

        // Add timestamps to data items
        function addTimestamps() {
            const now = new Date().toISOString();
            
            // Add timestamps to projects
            data.projects.forEach(project => {
                if (!project.createdAt) project.createdAt = now;
                if (!project.updatedAt) project.updatedAt = now;
            });
            
            // Add timestamps to tasks
            data.tasks.forEach(task => {
                if (!task.createdAt) task.createdAt = now;
                if (!task.updatedAt) task.updatedAt = now;
            });
            
            // Add timestamps to transactions
            data.transactions.forEach(transaction => {
                if (!transaction.createdAt) transaction.createdAt = now;
                if (!transaction.updatedAt) transaction.updatedAt = now;
            });
        }

        // Smart Merge Data Function
        function smartMergeData(remoteData) {
            if (!remoteData) return { added: 0, updated: 0, conflicts: 0 };
            
            let syncStats = { added: 0, updated: 0, conflicts: 0 };
            
            // Smart merge projects
            if (remoteData.projects) {
                remoteData.projects.forEach(remoteProject => {
                    const localProject = data.projects.find(p => p.id === remoteProject.id);
                    
                    if (!localProject) {
                        // New project from remote
                        data.projects.push(remoteProject);
                        syncStats.added++;
                    } else if (remoteProject.updatedAt && localProject.updatedAt) {
                        // Compare timestamps and keep the newer version
                        if (new Date(remoteProject.updatedAt) > new Date(localProject.updatedAt)) {
                            Object.assign(localProject, remoteProject);
                            syncStats.updated++;
                        } else if (new Date(remoteProject.updatedAt) < new Date(localProject.updatedAt)) {
                            // Local is newer, keep local version
                            syncStats.conflicts++;
                        }
                    }
                });
                
                // Check for local projects not in remote (need to be added to remote)
                data.projects.forEach(localProject => {
                    const remoteProject = remoteData.projects.find(p => p.id === localProject.id);
                    if (!remoteProject) {
                        // This is a new local project that needs to be synced
                        if (!localProject.updatedAt) {
                            localProject.updatedAt = new Date().toISOString();
                        }
                    }
                });
            }
            
            // Smart merge tasks
            if (remoteData.tasks) {
                remoteData.tasks.forEach(remoteTask => {
                    const localTask = data.tasks.find(t => t.id === remoteTask.id);
                    
                    if (!localTask) {
                        // New task from remote
                        data.tasks.push(remoteTask);
                        syncStats.added++;
                    } else if (remoteTask.updatedAt && localTask.updatedAt) {
                        // Compare timestamps and keep the newer version
                        if (new Date(remoteTask.updatedAt) > new Date(localTask.updatedAt)) {
                            Object.assign(localTask, remoteTask);
                            syncStats.updated++;
                        } else if (new Date(remoteTask.updatedAt) < new Date(localTask.updatedAt)) {
                            // Local is newer, keep local version
                            syncStats.conflicts++;
                        }
                    }
                });
                
                // Check for local tasks not in remote
                data.tasks.forEach(localTask => {
                    const remoteTask = remoteData.tasks.find(t => t.id === localTask.id);
                    if (!remoteTask) {
                        if (!localTask.updatedAt) {
                            localTask.updatedAt = new Date().toISOString();
                        }
                    }
                });
            }
            
            // Smart merge transactions
            if (remoteData.transactions) {
                remoteData.transactions.forEach(remoteTrans => {
                    const localTrans = data.transactions.find(t => t.id === remoteTrans.id);
                    
                    if (!localTrans) {
                        // New transaction from remote
                        data.transactions.push(remoteTrans);
                        syncStats.added++;
                    } else if (remoteTrans.updatedAt && localTrans.updatedAt) {
                        // Compare timestamps and keep the newer version
                        if (new Date(remoteTrans.updatedAt) > new Date(localTrans.updatedAt)) {
                            Object.assign(localTrans, remoteTrans);
                            syncStats.updated++;
                        } else if (new Date(remoteTrans.updatedAt) < new Date(localTrans.updatedAt)) {
                            // Local is newer, keep local version
                            syncStats.conflicts++;
                        }
                    }
                });
                
                // Check for local transactions not in remote
                data.transactions.forEach(localTrans => {
                    const remoteTrans = remoteData.transactions.find(t => t.id === localTrans.id);
                    if (!remoteTrans) {
                        if (!localTrans.updatedAt) {
                            localTrans.updatedAt = new Date().toISOString();
                        }
                    }
                });
            }
            
            // Smart merge settings - keep the most recently modified
            if (remoteData.settings) {
                // Preserve API settings
                const currentApiKey = data.settings.apiKey;
                const currentBinId = data.settings.binId;
                
                // Check if remote settings are newer
                if (remoteData.lastSync && data.lastSync) {
                    if (new Date(remoteData.lastSync) > new Date(data.lastSync)) {
                        // Remote is newer, use remote settings but preserve API keys
                        data.settings = { ...remoteData.settings };
                        data.settings.apiKey = currentApiKey;
                        data.settings.binId = currentBinId;
                        syncStats.updated++;
                    }
                } else {
                    // Merge settings intelligently
                    Object.keys(remoteData.settings).forEach(key => {
                        if (key !== 'apiKey' && key !== 'binId' && remoteData.settings[key] !== data.settings[key]) {
                            // Only update if remote has a value and local doesn't
                            if (remoteData.settings[key] && !data.settings[key]) {
                                data.settings[key] = remoteData.settings[key];
                            }
                        }
                    });
                }
            }
            
            saveData();
            applySettings();
            
            return syncStats;
        }

        // Helper Functions
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function getProjectName(projectId) {
            const project = data.projects.find(p => p.id === projectId);
            return project ? project.name : 'Unknown Project';
        }

        function getStatusColor(status) {
            const colors = {
                'Get Ready': 'warning',
                'In Progress': 'info',
                'Review': 'secondary',
                'Completed': 'success'
            };
            return colors[status] || 'secondary';
        }

        function getPriorityColor(priority) {
            const colors = {
                'High': 'danger',
                'Medium': 'warning',
                'Low': 'success'
            };
            return colors[priority] || 'secondary';
        }

        // Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // PWA Installation
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
        
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => {
                console.log('Service worker registration failed:', err);
            });
        }
    </script>
    
    <script>
        // Service Worker for PWA
        const swCode = `
            self.addEventListener('install', event => {
                self.skipWaiting();
            });
            
            self.addEventListener('activate', event => {
                event.waitUntil(clients.claim());
            });
            
            self.addEventListener('fetch', event => {
                event.respondWith(
                    fetch(event.request).catch(() => {
                        return new Response('Offline');
                    })
                );
            });
        `;
        
        // Create service worker file
        if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl);
        }
    </script>
</body>
</html>
